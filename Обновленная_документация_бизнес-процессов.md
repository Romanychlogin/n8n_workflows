# Обновленная документация бизнес-процессов системы автоматизации рекламных кампаний

*Создано на основе анализа реальных файлов: PDF описания процесса, SQL схем БД и n8n workflow*

## 1. Верхнеуровневое описание бизнес-процесса

### Общее описание
Система представляет собой комплексную платформу автоматизации создания и управления рекламными кампаниями для Яндекс.Директ с использованием ИИ. Основная цель - автоматизировать процесс создания рекламных объявлений, анализа ключевых слов, проверки минус-слов и мониторинга конкурентов.

### Ключевые компоненты системы:
1. **База данных n8n** - управление workflow и их состояниями
2. **База данных PGVector** - хранение векторных представлений для семантического поиска
3. **n8n workflows** - автоматизированные процессы
4. **OpenAI API** - генерация контента и эмбеддингов
5. **Яндекс.Директ API** - управление рекламными кампаниями
6. **Telegram Bot** - мониторинг и уведомления

### Основные бизнес-процессы (на основе PDF описания):

#### 1. Подготовка контента с сайта и дополнительных источников
- **1.1 Описание компании/сервисов**: полный список услуг и доступных промо-механик + полная карта сайта
  - Вариант (а): без ссылок и карты сайта
  - Вариант (б): полный с картой сайта
  - Два сценария: один продукт (например KIBERone) или несколько сервисов
- **1.2 Список ключевых фраз (черновой)**
- **1.3 Список конкурентов**

#### 2. Обработка списка ключевых фраз
- **2.1 Обогащение похожими фразами из Yandex Wordstat**
- **2.2 Загрузка списка минус-слов из базового**
- **2.3 Удаление нерелевантных фраз**
  - 2.3.1 Формирование company content - референс для фильтрации минус-слов
  - 2.3.2 Формирование списка минус-слов для нерелевантных фраз
- **2.4 Сбор статистики wordstat** (отложено)
- **2.5 Доочистка ключей** (отложено)
- **2.6 Генерация рекламных объявлений**: заголовок, текст, ссылка для каждой фразы
- **2.7 Генерация быстрых ссылок для объявлений**
- **2.8 Генерация уточнений для объявлений**

#### 3. Загрузка готовой рекламной кампании в Yandex Direct
- **3.1 Создание рекламной кампании через API** (запарковано)
- **3.2 Создание групп объявлений через API** (запарковано)
- **3.3 Создание объявлений через API** (запарковано)

#### 4. Ведение рекламной кампании
- **4.1 Анализ результатов отчета Яндекса по ключевым словам** (ежедневно)
  - 4.1.1 Загрузка отчета в БД
  - 4.1.2 Обработка отчета: проверка релевантности, поиск конкурентов, анализ фраз
- **4.2 Список ключевых слов** (загрузка руками в UI Директа)
- **4.3 Доочистка списка кандидатов ключевых фраз**
- **4.4 Генерация рекламных объявлений**
- **4.5 Выгрузка в файл для импорта**
- **4.6 Загрузка через Direct commander**

---

## 2. Реальная схема базы данных n8n

### Основные таблицы:

#### companies
```sql
CREATE TABLE public.companies (
    company_id bigint NOT NULL,                    -- Уникальный идентификатор компании (PK)
    company_name text,                             -- Название компании
    company_url text,                              -- URL сайта компании
    yandex_id text,                                -- ID компании в системе Яндекс.Директ
    yandex_region text,                            -- Регион для Яндекс.Директ (например, "53" для Саратова)
    created_at timestamp without time zone DEFAULT now(),  -- Дата создания записи
    updated_at timestamp without time zone DEFAULT now(),  -- Дата последнего обновления (автообновление через триггер)
    is_active boolean DEFAULT true,                -- Флаг активности компании
    description text                               -- Дополнительное описание компании
);
```
**Назначение**: Хранение информации о клиентах-компаниях
**Триггеры**: `companies_set_updated_at()` - автоматически обновляет `updated_at` при изменении записи

#### company_services
```sql
CREATE TABLE public.company_services (
    service_id bigint NOT NULL,                    -- Уникальный идентификатор услуги (PK)
    company_id bigint,                             -- Ссылка на компанию (FK -> companies.company_id)
    service_name text,                             -- Название услуги/сервиса
    service_url text,                              -- URL страницы услуги на сайте компании
    service_description text,                      -- Подробное описание услуги
    service_bid numeric(10,2),                     -- Ставка за услугу (для расчета приоритетов)
    created_at timestamp without time zone DEFAULT now(),  -- Дата создания записи
    updated_at timestamp without time zone DEFAULT now()   -- Дата последнего обновления
);
```
**Назначение**: Услуги и сервисы каждой компании
**Связи**: Связана с `companies` через `company_id`

#### key_words
```sql
CREATE TABLE public.key_words (
    key_word_id bigint NOT NULL,                   -- Уникальный идентификатор ключевого слова (PK)
    company_id bigint,                             -- Ссылка на компанию (FK -> companies.company_id)
    service_id bigint,                             -- Ссылка на услугу (FK -> company_services.service_id)
    key_word text NOT NULL,                        -- Само ключевое слово/фраза
    wordstat_count bigint DEFAULT 0,               -- Количество показов из Яндекс.Вордстат
    wordstat_parsed boolean DEFAULT false,         -- Флаг: обработано ли слово в Вордстат
    from_wordstat boolean DEFAULT false,           -- Флаг: получено ли слово из Вордстат (true) или добавлено вручную (false)
    is_relevant boolean DEFAULT true,              -- Флаг релевантности (определяется ИИ)
    ai_response_tokens bigint DEFAULT 0,           -- Количество токенов, потраченных на анализ этого слова
    created_at timestamp without time zone DEFAULT now()  -- Дата создания записи
);
```
**Назначение**: Ключевые слова с статистикой из Яндекс.Вордстат
**Связи**: Связана с `companies` и `company_services`

#### ads_list
```sql
CREATE TABLE public.ads_list (
    ad_id bigint NOT NULL,                         -- Уникальный идентификатор объявления (PK)
    group_name text,                               -- Название группы объявлений
    key_words text,                                -- Ключевые слова для этого объявления
    ad_header text,                                -- Заголовок рекламного объявления
    ad_text text,                                  -- Текст рекламного объявления
    group_id bigint DEFAULT 0,                     -- ID группы объявлений в Яндекс.Директ
    ad_url text,                                   -- URL целевой страницы с UTM-метками
    company_id bigint                              -- Ссылка на компанию (FK -> companies.company_id)
);
```
**Назначение**: Рекламные объявления
**Особенности**: Содержит готовые объявления для загрузки в Яндекс.Директ

#### minus_words
```sql
CREATE TABLE public.minus_words (
    id bigint NOT NULL,                            -- Уникальный идентификатор минус-слова (PK)
    company_id bigint,                             -- Ссылка на компанию (FK -> companies.company_id)
    minus_word text NOT NULL,                      -- Минус-слово для исключения из показов
    comment text,                                  -- Комментарий к минус-слову (причина добавления)
    created_at timestamp without time zone DEFAULT now()  -- Дата создания записи
);
```
**Назначение**: Минус-слова для исключения из показов
**Использование**: Исключают показы объявлений по нерелевантным запросам

#### company_content_from_user
```sql
CREATE TABLE public.company_content_from_user (
    id bigint NOT NULL,                            -- Уникальный идентификатор контента (PK)
    company_id bigint,                             -- Ссылка на компанию (FK -> companies.company_id)
    content_type text,                             -- Тип контента (описание, услуги, промо-механики и т.д.)
    content_text text,                             -- Текст контента
    file_url text,                                 -- URL файла с контентом (если загружен файл)
    created_at timestamp without time zone DEFAULT now(),  -- Дата создания записи
    updated_at timestamp without time zone DEFAULT now()   -- Дата последнего обновления
);
```
**Назначение**: Контент от пользователей для анализа
**Использование**: Хранит описания компаний, услуги, промо-механики для генерации объявлений

#### current_list
```sql
CREATE TABLE public.current_list (
    list_id bigint NOT NULL,                       -- Уникальный идентификатор записи (PK)
    key_word text,                                 -- Ключевое слово из отчета
    campaign_id text,                              -- ID кампании в Яндекс.Директ
    used_keyword text,                             -- Использованное ключевое слово в объявлении
    group_id text,                                 -- ID группы объявлений
    condition_type text,                           -- Тип условия показа (точное/фразовое/широкое соответствие)
    category text,                                 -- Категория объявления
    ads_header text,                               -- Заголовок объявления
    date date,                                     -- Дата показа
    count_views bigint,                            -- Количество показов
    count_clics bigint,                            -- Количество кликов
    count_convetions bigint,                       -- Количество конверсий
    resolution text,                               -- Решение по фразе (to add, no relevant, found competitor)
    ai_response_tokens bigint,                     -- Количество токенов ИИ для анализа
    created_at timestamp without time zone DEFAULT now()  -- Дата создания записи
);
```
**Назначение**: Временная таблица для анализа кампаний
**Использование**: Хранит данные из отчетов Яндекс.Директ для анализа эффективности

#### current_minus_words
```sql
CREATE TABLE public.current_minus_words (
    id bigint NOT NULL,                            -- Уникальный идентификатор (PK)
    minus_word text NOT NULL,                      -- Минус-слово, найденное при анализе
    current_record_id bigint,                      -- Ссылка на запись из current_list
    created_at timestamp without time zone DEFAULT now()  -- Дата создания записи
);
```
**Назначение**: Временная таблица для минус-слов
**Использование**: Хранит минус-слова, найденные при анализе кампаний

#### current_ads_list
```sql
CREATE TABLE public.current_ads_list (
    id bigint NOT NULL,                            -- Уникальный идентификатор (PK)
    add_adv text,                                  -- Флаг добавления объявления (+/-)
    ADV_type text,                                 -- Тип объявления
    mob text,                                      -- Мобильная версия (да/нет)
    group_uid text,                                -- Уникальный ID группы
    group_name text,                               -- Название группы
    group_id text,                                 -- ID группы
    id_phrase text,                                -- ID фразы
    key_words text,                                -- Ключевые слова
    id_adv text,                                   -- ID объявления
    ad_header text,                                -- Заголовок объявления
    ad_header2 text,                               -- Дополнительный заголовок
    ad_text text,                                  -- Текст объявления
    empty_1 text,                                  -- Пустое поле 1
    empty_2 text,                                  -- Пустое поле 2
    empty_3 text,                                  -- Пустое поле 3
    ad_url text,                                   -- URL объявления
    display_url text,                              -- Отображаемый URL
    company_id bigint,                             -- ID компании
    empty_4 text,                                  -- Пустое поле 4
    region text,                                   -- Регион показа
    auto_bid text,                                 -- Автоматическая ставка (да/нет)
    bid numeric(10,2),                             -- Размер ставки
    created_at timestamp without time zone DEFAULT now()  -- Дата создания записи
);
```
**Назначение**: Временная таблица для рекламных объявлений
**Использование**: Хранит объявления для экспорта в Яндекс.Директ

#### errors
```sql
CREATE TABLE public.errors (
    id bigint NOT NULL,                            -- Уникальный идентификатор ошибки (PK)
    responce text,                                 -- Ответ системы, вызвавший ошибку
    comment text,                                  -- Комментарий к ошибке
    list_num bigint,                               -- Номер записи в списке (для отладки)
    created_at timestamp without time zone DEFAULT now()  -- Дата создания записи
);
```
**Назначение**: Логирование ошибок
**Использование**: Хранит ошибки, возникающие при обработке данных

#### minus_words_global
```sql
CREATE TABLE public.minus_words_global (
    id bigint NOT NULL,                            -- Уникальный идентификатор (PK)
    minus_word text NOT NULL,                      -- Глобальное минус-слово
    category text                                  -- Категория минус-слова (города, "бесплатно", "скачать" и т.д.)
);
```
**Назначение**: Глобальная база минус-слов
**Использование**: Общие минус-слова для всех компаний (города, нерелевантные запросы)

### Дополнительные таблицы:

#### my_list
```sql
CREATE TABLE public.my_list (
    id bigint NOT NULL,                            -- Уникальный идентификатор (PK)
    key_word text,                                 -- Ключевое слово
    wordstat_count bigint,                         -- Количество показов из Вордстат
    is_relevant boolean,                           -- Флаг релевантности
    created_at timestamp without time zone DEFAULT now()  -- Дата создания записи
);
```
**Назначение**: Пользовательский список ключевых слов
**Использование**: Временное хранение ключевых слов для анализа

#### raw_list
```sql
CREATE TABLE public.raw_list (
    id bigint NOT NULL,                            -- Уникальный идентификатор (PK)
    key_word text,                                 -- Исходное ключевое слово
    wordstat_count bigint,                         -- Количество показов
    created_at timestamp without time zone DEFAULT now()  -- Дата создания записи
);
```
**Назначение**: Сырой список ключевых слов
**Использование**: Хранение необработанных данных из Вордстат

### Функции базы данных:

#### companies_set_updated_at()
```sql
CREATE FUNCTION public.companies_set_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at := now();
  RETURN NEW;
END
$$;
```
**Назначение**: Триггерная функция для автоматического обновления поля `updated_at`
**Применение**: Автоматически вызывается при обновлении записей в таблице `companies`

### Индексы и ограничения:

- **Primary Keys**: Все таблицы имеют первичные ключи типа `bigint`
- **Foreign Keys**: Связи между таблицами через внешние ключи
- **Sequences**: 12 последовательностей для автоинкремента ID
- **Indexes**: 13 индексов для оптимизации запросов
- **Constraints**: 60 ALTER TABLE операций для установки ограничений

### Схема связей между таблицами:

```
companies (основная таблица)
├── company_services (1:N) - услуги компании
├── key_words (1:N) - ключевые слова компании
├── ads_list (1:N) - рекламные объявления
├── minus_words (1:N) - минус-слова компании
├── company_content_from_user (1:N) - контент от пользователей
└── current_list (1:N) - временные данные анализа

company_services
└── key_words (1:N) - ключевые слова по услугам

current_list (временная таблица)
├── current_minus_words (1:N) - найденные минус-слова
└── current_ads_list (1:N) - объявления для экспорта

minus_words_global (справочная таблица)
└── используется всеми компаниями

errors (логирование)
└── независимая таблица для всех процессов
```

### Типы данных и их назначение:

- **bigint**: Идентификаторы и счетчики (ID, количество показов, токены)
- **text**: Текстовые поля (названия, описания, URL, ключевые слова)
- **boolean**: Флаги состояния (активность, релевантность, обработанность)
- **timestamp**: Временные метки (создание, обновление)
- **date**: Даты без времени (даты показов)
- **numeric(10,2)**: Денежные суммы (ставки, цены)

---

## 3. Детальные описания workflow (обновленные)

### 3.1 new_client_creation.json
**Назначение**: Создание нового клиента в системе

**Соответствует этапу**: 1.1 Описание компании/сервисов

**Основные этапы**:
1. Инициализация счетчика шагов
2. Вставка данных компании в таблицу `companies`
3. Отметка начала процесса в `business_processes_states`
4. Установка имени процесса ("company services")
5. Получение ID workflow
6. Подготовка входных данных для под-workflow
7. Вызов под-workflow
8. Обновление пройденных шагов
9. Отметка завершения процесса

### 3.2 company-services.json
**Назначение**: Извлечение и сохранение информации об услугах компании

**Соответствует этапу**: 1.1 Описание компании/сервисов (вариант с сервисами)

**Основные этапы**:
1. Отметка начала процесса
2. Получение промпта из GitHub
3. Условная загрузка описаний услуг и контента из Dropbox
4. Формирование комбинированного промпта
5. Отправка запроса к OpenAI (gpt-5)
6. Парсинг JSON ответа для извлечения данных об услугах
7. Вставка данных в таблицу `company_services`
8. Отслеживание шагов и токенов
9. Завершение процесса

### 3.3 ads-headers-and-texts-creation.json
**Назначение**: Создание заголовков и текстов рекламных объявлений

**Соответствует этапу**: 2.6 Генерация рекламных объявлений

**Основные этапы**:
1. Загрузка CSV файла по URL
2. Извлечение данных
3. Циклическая обработка элементов
4. Формирование промпта для OpenAI
5. Отправка запроса к модели
6. Парсинг ответа для извлечения заголовка, текста и URL
7. Проверка валидности данных
8. Вставка данных в таблицу `ads_list`
9. Логирование ошибок при невалидных данных

### 3.4 Check_minus_words.json
**Назначение**: Проверка текста на наличие минус-слов

**Соответствует этапу**: 2.3.2 Формирование списка минус-слов

**Основные этапы**:
1. Извлечение n-грамм из входного текста
2. Генерация эмбеддингов через OpenAI
3. Векторный поиск в таблице `company_content`
4. Проверка превышения порога схожести
5. Агрегация найденных совпадений
6. Обновление таблицы `minus_words`

### 3.5 extract-data-for-initial-load.json
**Назначение**: Извлечение рекламных данных для первоначальной загрузки

**Соответствует этапу**: 4.5 Выгрузка в файл для импорта

**Основные этапы**:
1. Установка переменных (имя компании, URL, порог)
2. Выборка данных компании из `companies`
3. Выборка рекламных данных из `ads_list`
4. Обработка данных JavaScript для группировки и батчинга
5. Редактирование полей
6. Конвертация в XLSX файл
7. Загрузка в Dropbox

### 3.6 ADV_campaign_analysis.json
**Назначение**: Анализ рекламных кампаний

**Соответствует этапу**: 4.1.2 Обработка отчета

**Основные этапы**:
1. Очистка временных таблиц (`current_list`, `current_minus_words`, `current_ads_list`)
2. Загрузка CSV файла с данными кампании
3. Вставка данных в `current_list`
4. Проверка пословного соответствия
5. Анализ релевантности через OpenAI
6. Поиск упоминаний конкурентов
7. Обновление статуса записей
8. Вставка найденных минус-слов

### 3.7 wordstat-xmlriver.json
**Назначение**: Получение статистики из Яндекс.Вордстат

**Соответствует этапу**: 2.1 Обогащение похожими фразами из Yandex Wordstat

**Основные этапы**:
1. Выборка необработанных ключевых слов
2. Запрос к API xmlriver.com
3. Обработка ответа и извлечение статистики
4. Проверка существования ключевых слов
5. Обновление или вставка новых записей
6. Отметка обработанных слов

### 3.8 check-vs-company-name.json
**Назначение**: Проверка упоминаний конкурентов в тексте

**Соответствует этапу**: 4.1.2 Обработка отчета (поиск конкурентов)

**Основные этапы**:
1. Извлечение n-грамм из входного текста
2. Генерация эмбеддингов для каждого n-грамма
3. Векторный поиск в базе конкурентов
4. Проверка превышения порога схожести
5. Агрегация найденных совпадений
6. Возврат результатов через webhook

### 3.9 status-bot.json
**Назначение**: Мониторинг состояния процессов и отправка уведомлений

**Основные функции**:
1. **Мониторинг ошибок** (каждую минуту)
2. **Мониторинг статусов** (каждые 10 минут)
3. **Уведомления о завершении** (каждую минуту)

### 3.10 github_repo_workflows_sync.json
**Назначение**: Синхронизация workflow между n8n и GitHub

**Основные этапы**:
1. Получение списка workflow из n8n
2. Получение списка файлов из GitHub репозитория
3. Сравнение версий и дат обновления
4. Синхронизация изменений
5. Отправка уведомлений о результатах

---

## 4. Интеграции и внешние сервисы

### 4.1 OpenAI API
- **Модели**: gpt-4o, gpt-5, text-embedding-3-small
- **Использование**: Генерация контента, анализ текста, создание эмбеддингов
- **Отслеживание**: Количество использованных токенов

### 4.2 Яндекс.Директ API
- **Функции**: Управление рекламными кампаниями
- **Статус**: Частично реализовано (некоторые функции запаркованы)

### 4.3 Яндекс.Вордстат
- **API**: xmlriver.com
- **Функции**: Получение статистики по ключевым словам
- **Регионы**: Настраиваемые регионы

### 4.4 Dropbox API
- **Функции**: Хранение и загрузка файлов
- **Форматы**: CSV, XLSX, JSON

### 4.5 GitHub API
- **Функции**: Синхронизация workflow, хранение промптов
- **Репозиторий**: n8n_workflows

### 4.6 Telegram Bot
- **Функции**: Уведомления о статусе процессов
- **Каналы**: 
  - Инциденты: -1003052639964
  - Статусы: -1002955047432
  - GitHub статус: -1003120484933

---

## 5. Технические долги и TODO (из PDF)

### 5.1 Критичные задачи
1. **Переделать обработку конкурентов**:
   - `fill competitors + insert competitors names embeddings + Process competitors names`
   - `Fill competitors services + Create competitors variants + insert competitors names embeddings`

2. **Переделать анализ ключевых слов**:
   - `Keys list analysis` - старая реализация, нужно переделать на базе ведения компании
   - `key_words_with_services_analysis` - разные промпты для первичной итерации

3. **Доработать группировку объявлений**:
   - Найти SQL скрипт для группировки
   - Проанализировать работу с группами

### 5.2 Запаркованные задачи
1. **API Яндекс.Директ**: создание кампаний, групп, объявлений
2. **Call tracking**: настройка минимум для себя
3. **Работа с метрикой клиентов**: есть ручные операции
4. **Заведение агентства на Яндексе**
5. **Агент для онбординга клиентов**

### 5.3 Отложенные задачи
1. **Сбор статистики wordstat**: не уверен что нужна при автоматизированной обработке
2. **Доочистка ключей**: анализ неявных дублей, обрезка до 7 слов
3. **Быстрые ссылки и уточнения**: можно в полуручном режиме

### 5.4 Технические улучшения
1. **Минус-слова**: убрать +, # символы
2. **Новые ключевые фразы**: 
   - Повторно прогнать по полному списку минус-слов
   - Доработать промпт (убрать: как *, какие, это)
   - Убрать служебные символы из ключевых фраз
   - Обрезать не более 7 слов
3. **Качество обрезки**: доработать качество обрезки заголовков и текстов

---

## 6. Рекомендации по развитию

### 6.1 Краткосрочные улучшения (1-2 месяца)
1. **Завершить переделку анализа конкурентов**
2. **Реализовать key_words_with_services_analysis**
3. **Найти и доработать SQL скрипты группировки**
4. **Улучшить обработку минус-слов**

### 6.2 Среднесрочные улучшения (3-6 месяцев)
1. **Реализовать API Яндекс.Директ**
2. **Настроить call tracking**
3. **Автоматизировать работу с метрикой**
4. **Создать агента для онбординга**

### 6.3 Долгосрочные улучшения (6+ месяцев)
1. **Микросервисная архитектура**
2. **Машинное обучение для оптимизации**
3. **A/B тестирование объявлений**
4. **Интеграция с другими рекламными платформами**

---

## 7. Заключение

Система представляет собой хорошо структурированную платформу автоматизации рекламных кампаний с активным использованием ИИ. Основные процессы реализованы и работают, но есть ряд технических долгов, которые требуют внимания для полной автоматизации процесса.

**Сильные стороны**:
- Комплексный подход к автоматизации
- Активное использование ИИ для анализа и генерации контента
- Хорошая система мониторинга и логирования
- Модульная архитектура workflow

**Области для улучшения**:
- Завершение переделки критичных компонентов
- Реализация API интеграций
- Улучшение качества обработки данных
- Автоматизация ручных операций

---

*Документация создана на основе анализа реальных файлов: PDF описания процесса, SQL схем БД n8n и 50+ n8n workflow файлов.*
