{
  "createdAt": "2025-09-18T08:52:43.182Z",
  "updatedAt": "2025-09-22T15:10:52.752Z",
  "id": "v2Z32ISEUzsFYnZw",
  "name": "error workflow state",
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "update business_processes_states set error_happened=NOW(),error_message=$3 where business_process_id=(select MAX(business_process_id) from business_processes where n8n_process_name=$1) and n8n_workflow_execution_id=$2",
        "options": {
          "queryReplacement": "=[{{$json.workflow.name}},{{$json.execution.id}},{{ 'node:'+$json.execution.lastNodeExecuted + ' error:' + $json.execution.error.message }}]"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -432,
        16
      ],
      "id": "8bb08a99-b563-4b89-89cd-fad323df84a0",
      "name": "Mark_workflow_error",
      "executeOnce": true,
      "credentials": {
        "postgres": {
          "id": "4YkdFJcdTgzo9hkz",
          "name": "PGvector"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.errorTrigger",
      "typeVersion": 1,
      "position": [
        -912,
        16
      ],
      "id": "6fec366a-8339-4564-b855-267133d45b2e",
      "name": "Error Trigger"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH RECURSIVE chain AS (\n  SELECT s.business_process_state_id,\n         s.business_process_id,\n         s.n8n_workflow_execution_id,\n         s.n8n_workflow_root_execution_id,\n         0 AS depth\n  FROM business_processes_states s\n  WHERE s.business_process_id = (\n          SELECT MAX(bp.business_process_id)\n          FROM business_processes bp\n          WHERE bp.n8n_process_name = $1\n        )\n    AND s.n8n_workflow_execution_id = $2\n\n  UNION ALL\n\n  SELECT p.business_process_state_id,\n         p.business_process_id,\n         p.n8n_workflow_execution_id,\n         p.n8n_workflow_root_execution_id,\n         c.depth + 1\n  FROM business_processes_states p\n  JOIN chain c\n    ON p.n8n_workflow_execution_id = c.n8n_workflow_root_execution_id\n)\nUPDATE business_processes_states s\nSET    error_happened = NOW(),\n       error_message  = 'Error in the child process'\nWHERE  s.business_process_id IN (\n  SELECT DISTINCT business_process_id FROM chain WHERE depth > 0 \n);\n",
        "options": {
          "queryReplacement": "=[{{ $('Error Trigger').item.json.workflow.name }},{{ $('Error Trigger').item.json.execution.id }}]"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -224,
        16
      ],
      "id": "b589274a-f856-4af8-b342-bf3004de6e57",
      "name": "Update root process",
      "credentials": {
        "postgres": {
          "id": "4YkdFJcdTgzo9hkz",
          "name": "PGvector"
        }
      }
    }
  ],
  "connections": {
    "Error Trigger": {
      "main": [
        [
          {
            "node": "Mark_workflow_error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mark_workflow_error": {
      "main": [
        [
          {
            "node": "Update root process",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {
    "Error Trigger": [
      {
        "json": {
          "execution": {
            "id": "16904",
            "url": "http://localhost:5678/workflow/ezK8ihYnfxZNTIAc/executions/16904",
            "error": {
              "level": "warning",
              "tags": {},
              "description": "Failed query: update business_processes_states set steps_passed=$3, tokens_used=$4,tokens_used_type=$5 where business_process_id=(select MAX(business_process_id) from business_processes where n8n_process_name=$1) and n8n_workflow_execution_id=$2",
              "timestamp": 1758452915600,
              "context": {},
              "functionality": "regular",
              "name": "NodeOperationError",
              "node": {
                "parameters": {
                  "resource": "database",
                  "operation": "executeQuery",
                  "query": "update business_processes_states set steps_passed=$3, tokens_used=$4,tokens_used_type=$5 where business_process_id=(select MAX(business_process_id) from business_processes where n8n_process_name=$1) and n8n_workflow_execution_id=$2",
                  "options": {
                    "queryReplacement": "=[{{$workflow.name}},{{$execution.id}},{{$json.steps_passed}},{{$json.tokens_used}},{{ 'gpt-5' }}]"
                  }
                },
                "type": "n8n-nodes-base.postgres",
                "typeVersion": 2.6,
                "position": [
                  4400,
                  -256
                ],
                "id": "0a9bdd25-98b8-459f-ae44-e3d8d16e94cb",
                "name": "Mark_workflow_passed_steps",
                "executeOnce": true,
                "credentials": {
                  "postgres": {
                    "id": "4YkdFJcdTgzo9hkz",
                    "name": "PGvector"
                  }
                }
              },
              "messages": [],
              "message": "there is no parameter $4",
              "stack": "NodeOperationError: there is no parameter $4\n    at parsePostgresError (/usr/local/lib/node_modules/n8n/node_modules/.pnpm/n8n-nodes-base@file+packages+nodes-base_@aws-sdk+credential-providers@3.808.0_asn1.js@5_afd197edb2c1f848eae21a96a97fab23/node_modules/n8n-nodes-base/nodes/Postgres/v2/helpers/utils.ts:124:9)\n    at /usr/local/lib/node_modules/n8n/node_modules/.pnpm/n8n-nodes-base@file+packages+nodes-base_@aws-sdk+credential-providers@3.808.0_asn1.js@5_afd197edb2c1f848eae21a96a97fab23/node_modules/n8n-nodes-base/nodes/Postgres/v2/helpers/utils.ts:279:19\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n    at ExecuteContext.execute (/usr/local/lib/node_modules/n8n/node_modules/.pnpm/n8n-nodes-base@file+packages+nodes-base_@aws-sdk+credential-providers@3.808.0_asn1.js@5_afd197edb2c1f848eae21a96a97fab23/node_modules/n8n-nodes-base/nodes/Postgres/v2/actions/database/executeQuery.operation.ts:149:9)\n    at ExecuteContext.router (/usr/local/lib/node_modules/n8n/node_modules/.pnpm/n8n-nodes-base@file+packages+nodes-base_@aws-sdk+credential-providers@3.808.0_asn1.js@5_afd197edb2c1f848eae21a96a97fab23/node_modules/n8n-nodes-base/nodes/Postgres/v2/actions/router.ts:41:17)\n    at ExecuteContext.execute (/usr/local/lib/node_modules/n8n/node_modules/.pnpm/n8n-nodes-base@file+packages+nodes-base_@aws-sdk+credential-providers@3.808.0_asn1.js@5_afd197edb2c1f848eae21a96a97fab23/node_modules/n8n-nodes-base/nodes/Postgres/v2/PostgresV2.node.ts:26:10)\n    at WorkflowExecute.executeNode (/usr/local/lib/node_modules/n8n/node_modules/.pnpm/n8n-core@file+packages+core_@opentelemetry+api@1.9.0_@opentelemetry+sdk-trace-base@1.30_08b575bec2313d5d8a4cc75358971443/node_modules/n8n-core/src/execution-engine/workflow-execute.ts:1254:8)\n    at WorkflowExecute.runNode (/usr/local/lib/node_modules/n8n/node_modules/.pnpm/n8n-core@file+packages+core_@opentelemetry+api@1.9.0_@opentelemetry+sdk-trace-base@1.30_08b575bec2313d5d8a4cc75358971443/node_modules/n8n-core/src/execution-engine/workflow-execute.ts:1428:11)\n    at /usr/local/lib/node_modules/n8n/node_modules/.pnpm/n8n-core@file+packages+core_@opentelemetry+api@1.9.0_@opentelemetry+sdk-trace-base@1.30_08b575bec2313d5d8a4cc75358971443/node_modules/n8n-core/src/execution-engine/workflow-execute.ts:1760:27\n    at /usr/local/lib/node_modules/n8n/node_modules/.pnpm/n8n-core@file+packages+core_@opentelemetry+api@1.9.0_@opentelemetry+sdk-trace-base@1.30_08b575bec2313d5d8a4cc75358971443/node_modules/n8n-core/src/execution-engine/workflow-execute.ts:2337:11"
            },
            "lastNodeExecuted": "Mark_workflow_passed_steps",
            "mode": "integrated"
          },
          "workflow": {
            "id": "ezK8ihYnfxZNTIAc",
            "name": "ADS headers and texts creation services"
          }
        }
      }
    ]
  },
  "versionId": "b00405eb-fce1-49d8-a4f7-0fea527d48cd",
  "triggerCount": 0,
  "shared": [
    {
      "createdAt": "2025-09-18T08:52:43.182Z",
      "updatedAt": "2025-09-18T08:52:43.182Z",
      "role": "workflow:owner",
      "workflowId": "v2Z32ISEUzsFYnZw",
      "projectId": "spKmbJLU4mvACXIB"
    }
  ],
  "tags": []
}