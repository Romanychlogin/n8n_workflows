{
  "createdAt": "2025-10-07T08:30:30.743Z",
  "updatedAt": "2025-10-14T13:30:31.647Z",
  "id": "W3unG2eSSwWcYUG0",
  "name": "minus words post processing",
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "content": "Берем все минус слова клиента (minus_words) и для них отбираем топ слов по весам, так чтобы общая длина не больше 20000 символов. 0) очищаем поле export_to_yandex 1)помечаем в поле export_to_yandex=true 2)возвращаем все полученные слова списком в одно поле в формате \"-1С Клуб программистовв -1С клуб програмистов -1с\"",
        "height": 128,
        "width": 608
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -112,
        -192
      ],
      "id": "6cdfae3f-f08e-4ccd-a85a-c348faec3743",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "inputSource": "passthrough"
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -1088,
        224
      ],
      "id": "626f037d-bf2a-4ef6-b4b3-e1d8e3e464fd",
      "name": "When Executed by Another Workflow"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "update business_processes_states set finished=NOW(),tokens_used=0,steps_passed=1,steps_total=1 where business_process_id=(select MAX(business_process_id) from business_processes where n8n_process_name=$1) and n8n_workflow_execution_id=$2",
        "options": {
          "queryReplacement": "=[{{$workflow.name}},{{$execution.id}}]"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        736,
        176
      ],
      "id": "6cf98fa3-fdd8-4102-bc21-b37e7077a7b9",
      "name": "Mark_workflow_completed",
      "executeOnce": true,
      "credentials": {
        "postgres": {
          "id": "4YkdFJcdTgzo9hkz",
          "name": "PGvector"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH agg AS (\n  SELECT\n    mw.id,\n    mw.minus_word,\n    mw.weight,\n    BOOL_OR(org.key_word_id = 0) AS has_zero\n  FROM minus_words AS mw\n  JOIN minus_words_origin AS org\n    ON org.minus_word_id = mw.id\n  WHERE mw.company_id = $1\n  GROUP BY mw.id, mw.minus_word, mw.weight\n)\nSELECT minus_word, weight,id as minus_word_id\nFROM agg\nORDER BY\n  CASE WHEN has_zero THEN 0 ELSE 1 END,  -- сначала те, у кого есть key_word_id = 0\n  weight DESC NULLS LAST;                -- затем по weight DESC",
        "options": {
          "queryReplacement": "={{ $('When Executed by Another Workflow').item.json.company_id }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -448,
        224
      ],
      "id": "7b77e81d-c943-4650-8cb5-af9d708d1d8d",
      "name": "Get minus_words",
      "credentials": {
        "postgres": {
          "id": "Hx2VFmUi5WO2K4QX",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "content": "Get first base minus words, than all other ordered by weight"
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -528,
        144
      ],
      "id": "d679bc5c-27ea-4669-a26c-a519e2136f74",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO business_processes_states (business_process_id, company_id,n8n_workflow_execution_id,n8n_workflow_root_execution_id, started)\nSELECT MAX(business_process_id), $2,$3,$4, NOW()\nFROM public.business_processes\nWHERE n8n_process_name = $1;",
        "options": {
          "queryReplacement": "=[{{$workflow.name}},{{$json.company_id}},{{$execution.id}},{{ $('When Executed by Another Workflow').item.json.root_execution_id }}]"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -816,
        224
      ],
      "id": "0fbf7be6-7eb9-4baa-bf17-051fb0754b1f",
      "name": "Mark_workwlow_started",
      "credentials": {
        "postgres": {
          "id": "4YkdFJcdTgzo9hkz",
          "name": "PGvector"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Function-Node (Run Once)\nconst workflowData = $getWorkflowStaticData('global');\nworkflowData.steps_passed = 0;\nworkflowData.tokens_used = 0;\nworkflowData.step = 0;\nreturn $input.all();\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -240,
        224
      ],
      "id": "f12c3a8a-db94-412e-a86b-f9079799f86f",
      "name": "Init total counter"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "e7a291b9-4915-4184-96a2-062b799244f0",
              "name": "minus_words",
              "value": "={{ $('generate minus words list').item.json.result }}",
              "type": "string"
            },
            {
              "id": "fa903b85-9a59-49d8-ba2b-6895d7a94213",
              "name": "words_count",
              "value": "={{ $('generate minus words list').item.json.token_count }}",
              "type": "string"
            },
            {
              "id": "12294144-b8e2-4834-8c1d-8bdbcf3055ac",
              "name": "length",
              "value": "={{ $('generate minus words list').item.json.length }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        912,
        160
      ],
      "id": "db846178-7db1-4a0f-a97b-609d9c673b52",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "update minus_words set export_to_yandex=false where company_id=$1",
        "options": {
          "queryReplacement": "={{ $('When Executed by Another Workflow').item.json.company_id }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        160,
        240
      ],
      "id": "39b1226e-c031-400b-a4f9-a81790caad5e",
      "name": "Reset export to yandex",
      "executeOnce": true,
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "Hx2VFmUi5WO2K4QX",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "update minus_words set export_to_yandex=true where id=$1",
        "options": {
          "queryReplacement": "={{$json.minus_word_id}}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        512,
        224
      ],
      "id": "f885c8ea-58e7-4728-ac88-e85d2790f5fc",
      "name": "Mark exported to yandex",
      "credentials": {
        "postgres": {
          "id": "Hx2VFmUi5WO2K4QX",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const LIMIT = 20000; // общий лимит, включая скобки\nlet minus_words_ids=[];\nconst items = $input.all();\nlet parts = [];\nlet currentLen = 2; // учтём \"(\" и \")\"\n\nfor (const it of items) {\n  const word = String(it.json?.minus_word ?? '').trim();\n  if (!word) continue;\n\n  const token = '-' + word; // формат \"-word\"\n  const addLen = (parts.length ? 1 : 0) + token.length; // пробел перед токеном (кроме первого) + длина токена\n\n  if (currentLen + addLen > LIMIT) break;\n   minus_words_ids.push(it.json?.minus_word_id);\n  parts.push(token);\n  currentLen += addLen;\n}\n\nconst result =  parts.join(' ') ;\n\nreturn [\n  {\n    json: {\n      result,\n      token_count: parts.length,\n      length: result.length,\n      minus_words_ids\n    },\n  },\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -16,
        224
      ],
      "id": "08262b86-aa48-48ab-a1a0-d4656bff7ba5",
      "name": "generate minus words list"
    },
    {
      "parameters": {
        "jsCode": "// Loop over input items and add a new field called 'myNewField' to the JSON of each one\nconst out = [];\nfor (const item of $in$('generate minus words list').first().json.minus_word_ids) {\n  out.push({ json: { minus_word_id: item } }); \n}\n\nreturn out;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        320,
        240
      ],
      "id": "efa4d60c-f179-4903-a2a8-fd299365bd48",
      "name": "Code in JavaScript"
    }
  ],
  "connections": {
    "When Executed by Another Workflow": {
      "main": [
        [
          {
            "node": "Mark_workwlow_started",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get minus_words": {
      "main": [
        [
          {
            "node": "Init total counter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mark_workwlow_started": {
      "main": [
        [
          {
            "node": "Get minus_words",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Init total counter": {
      "main": [
        [
          {
            "node": "generate minus words list",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mark_workflow_completed": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reset export to yandex": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mark exported to yandex": {
      "main": [
        [
          {
            "node": "Mark_workflow_completed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "generate minus words list": {
      "main": [
        [
          {
            "node": "Reset export to yandex",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Mark exported to yandex",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {
    "When Executed by Another Workflow": [
      {
        "json": {
          "company_id": 1,
          "root_execution_id": 74293
        }
      }
    ]
  },
  "versionId": "3d4f1b5c-4bfb-420e-bee7-900c99078af4",
  "triggerCount": 0,
  "shared": [
    {
      "createdAt": "2025-10-07T08:30:30.743Z",
      "updatedAt": "2025-10-07T08:30:30.743Z",
      "role": "workflow:owner",
      "workflowId": "W3unG2eSSwWcYUG0",
      "projectId": "spKmbJLU4mvACXIB"
    }
  ],
  "tags": [
    {
      "createdAt": "2025-10-08T11:53:55.048Z",
      "updatedAt": "2025-10-08T11:53:55.048Z",
      "id": "bfaXXdoIW5NToPfb",
      "name": "post procesing"
    }
  ]
}