{
  "createdAt": "2025-10-21T12:43:03.776Z",
  "updatedAt": "2025-10-21T22:25:09.192Z",
  "id": "Z5sOyh4IJtSVsD2a",
  "name": "Recieve form data",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "add0a254-19eb-4e02-b02e-344a6f26a86e",
        "options": {
          "rawBody": true
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        0,
        0
      ],
      "id": "53703b18-b0c9-4def-a05e-6591c46fc7ec",
      "name": "Webhook",
      "webhookId": "add0a254-19eb-4e02-b02e-344a6f26a86e"
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "{\n  \"alfacrm\": {\n    \"host\": \"kiberonesaratov.s20.online\",\n    \"email\": \"antonkarzhavin1@yandex.ru\",\n    \"api_key\": \"656b9709-9547-11f0-b9b8-3cecefbdd1ae\",\n    \"lead_source_id\": 1,\n    \"branch_id\": 1,\n  }\n}",
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        512,
        0
      ],
      "id": "bfa32a75-2fb1-4ecb-a0f9-1c7e2982656c",
      "name": "Set CRM data"
    },
    {
      "parameters": {
        "jsCode": "/**\n * AlfaCRM phone write diagnostic\n * Создаём customer -> пробуем 3 варианта update, каждый раз читаем обратно.\n * Видим, какой способ реально записывает телефон на инстансе.\n */\n\nasync function http(req) { return await this.helpers.httpRequest(req); }\n\nasync function login(self, { host, email, api_key }) {\n  const res = await http.call(self, {\n    method: 'POST',\n    url: `https://${host}/v2api/auth/login`,\n    headers: { 'Content-Type': 'application/json' },\n    body: { email, api_key },\n    json: true,\n  });\n  if (!res?.token) throw new Error('Auth failed');\n  return res.token;\n}\n\nasync function createCustomer(self, { host, token, payload }) {\n  return await http.call(self, {\n    method: 'POST',\n    url: `https://${host}/v2api/1/customer/create`,\n    headers: { 'Content-Type': 'application/json', 'X-ALFACRM-TOKEN': token },\n    body: payload,\n    json: true, gzip: true, timeout: 20000,\n  });\n}\n\nasync function updateCustomer(self, { host, token, id, payload }) {\n  return await http.call(self, {\n    method: 'POST',\n    url: `https://${host}/v2api/1/customer/update`,\n    qs: { id },\n    headers: { 'Content-Type': 'application/json', 'X-ALFACRM-TOKEN': token },\n    body: payload,\n    json: true, gzip: true, timeout: 20000,\n  });\n}\n\nasync function getCustomer(self, { host, token, id }) {\n  const res = await http.call(self, {\n    method: 'POST',\n    url: `https://${host}/v2api/1/customer/index`,\n    headers: { 'Content-Type': 'application/json', 'X-ALFACRM-TOKEN': token },\n    body: { id, page: 0 },\n    json: true, gzip: true, timeout: 20000,\n  });\n  const items = Array.isArray(res?.items) ? res.items : [];\n  return items.find(i => Number(i.id) === Number(id)) || null;\n}\n\n// helpers\nconst notEmpty = v => v !== undefined && v !== null && String(v).trim() !== '';\nconst toNum = v => {\n  if (!notEmpty(v)) return undefined;\n  const n = Number(String(v).trim());\n  return Number.isFinite(n) ? n : undefined;\n};\nfunction asObj(maybe) {\n  if (!maybe) return {};\n  if (typeof maybe === 'object') return maybe;\n  if (typeof maybe === 'string') { try { return JSON.parse(maybe); } catch { return {}; } }\n  return {};\n}\n// оставляем + и цифры\nfunction normalizePhone(p) {\n  const s = String(p || '').trim();\n  if (!s) return '';\n  const kept = s.replace(/[^\\d+]/g, '');\n  // если несколько плюсов — оставим только первый\n  return kept.replace(/^\\++/, '+').replace(/\\+/g, (m, i) => (i === 0 ? '+' : ''));\n}\n\n// MAIN\nconst items = await $input.all();\nconst out = [];\n\nfor (const it of items) {\n  const input = it.json ?? it;\n  const conf = input.alfacrm || {};\n  const host = conf.host || input.host;\n  const email = conf.email || input.email;\n  const api_key = conf.api_key || input.api_key;\n  if (!host || !email || !api_key) throw new Error('Provide alfacrm.host, alfacrm.email, alfacrm.api_key');\n\n  const token = await login(this, { host, email, api_key });\n\n  // исходные поля\n  const f = asObj(input.fields);\n  const rawPhone = f[\"1_3\"] || input.phone || \"\";\n  const phone = normalizePhone(rawPhone);\n  const name = f[\"1_2\"] || input.name || \"Тест диагностика телефона\";\n  const city = f[\"1_7\"] || input.city || \"\";\n  const lead_source_id = toNum(input.lead_source_id) ?? 3;\n\n  // создаём без телефона, чтобы не мешал\n  const createPayload = {\n    name,\n    branch_ids: [1],\n    legal_type: 1,\n    is_study: 0,\n    lead_source_id,\n    ...(city ? { note: `Город: ${city}` } : {}),\n  };\n  const created = await createCustomer(this, { host, token, payload: createPayload });\n  const id = created?.model?.id || created?.id;\n  if (!id) throw new Error('Created without id');\n\n  const phases = [];\n\n  // Phase A: пробуем contact_contacts\n  let resA = null, afterA = null;\n  try {\n    if (notEmpty(phone)) {\n      resA = await updateCustomer(this, { host, token, id, payload: { contact_contacts: [phone] } });\n    }\n    afterA = await getCustomer(this, { host, token, id });\n    phases.push({\n      phase: 'A_contact_contacts_only',\n      request: { contact_contacts: notEmpty(phone) ? [phone] : [] },\n      saved: {\n        contact_contacts: afterA?.contact_contacts || [],\n        phone: afterA?.phone || [],\n      }\n    });\n  } catch (e) {\n    phases.push({ phase: 'A_contact_contacts_only', error: e?.response?.body || e.message });\n  }\n\n  // Если уже записалось — больше не мучаем\n  const okAfterA = Array.isArray(afterA?.contact_contacts) && afterA.contact_contacts.includes(phone);\n\n  // Phase B: пробуем phone\n  if (!okAfterA && notEmpty(phone)) {\n    try {\n      await updateCustomer(this, { host, token, id, payload: { phone: [phone] } });\n      const afterB = await getCustomer(this, { host, token, id });\n      phases.push({\n        phase: 'B_phone_only',\n        request: { phone: [phone] },\n        saved: {\n          contact_contacts: afterB?.contact_contacts || [],\n          phone: afterB?.phone || [],\n        }\n      });\n    } catch (e) {\n      phases.push({ phase: 'B_phone_only', error: e?.response?.body || e.message });\n    }\n  }\n\n  // Phase C: пробуем оба сразу (если ни один не сработал)\n  const last = phases[phases.length - 1];\n  const lastSaved = last?.saved || {};\n  const alreadyHas =\n    (lastSaved.contact_contacts || []).includes(phone) ||\n    (lastSaved.phone || []).includes(phone);\n\n  if (!alreadyHas && notEmpty(phone)) {\n    try {\n      await updateCustomer(this, { host, token, id, payload: { contact_contacts: [phone], phone: [phone] } });\n      const afterC = await getCustomer(this, { host, token, id });\n      phases.push({\n        phase: 'C_both_contact_contacts_and_phone',\n        request: { contact_contacts: [phone], phone: [phone] },\n        saved: {\n          contact_contacts: afterC?.contact_contacts || [],\n          phone: afterC?.phone || [],\n        }\n      });\n    } catch (e) {\n      phases.push({ phase: 'C_both_contact_contacts_and_phone', error: e?.response?.body || e.message });\n    }\n  }\n\n  out.push({\n    json: {\n      id,\n      phone_try: phone,\n      phases\n    }\n  });\n}\n\nreturn out;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1056,
        0
      ],
      "id": "4d3da4ba-604a-465f-9de8-3a1d247a97f8",
      "name": "Send Lead data to CRM"
    },
    {
      "parameters": {
        "jsCode": "// n8n Code (JavaScript) — Run Once for All Items\nconst items = await $input.all();\n\n// --- helpers ---\nconst notEmpty = v => v !== undefined && v !== null && String(v).trim() !== '';\n\nfunction tryParseJSON(s) {\n  if (typeof s !== 'string') return s;\n  try { return JSON.parse(s); } catch { return s; }\n}\n\nfunction getQueryParam(url, name) {\n  try { return new URL(String(url)).searchParams.get(name); } catch { return null; }\n}\n\n/**\n * Рекурсивно находит ВСЕ ключи \"lead_source_id\" и подменяет значение.\n * Сохраняет тип: если раньше было \"40\" (string), запишет \"8\"/\"3\" как строку.\n * Возвращает количество замен.\n */\nfunction replaceLeadSourceId(obj, newValNumber) {\n  let count = 0;\n  const stack = [obj];\n  const seen = new Set();\n\n  while (stack.length) {\n    const cur = stack.pop();\n    if (!cur || typeof cur !== 'object') continue;\n    if (seen.has(cur)) continue;\n    seen.add(cur);\n\n    if (Array.isArray(cur)) {\n      for (const v of cur) if (v && typeof v === 'object') stack.push(v);\n      continue;\n    }\n\n    for (const [k, v] of Object.entries(cur)) {\n      if (k === 'lead_source_id') {\n        const keepString = typeof v === 'string';\n        cur[k] = keepString ? String(newValNumber) : newValNumber;\n        count++;\n      }\n      if (v && typeof v === 'object') stack.push(v);\n    }\n  }\n  return count;\n}\n\nfor (const item of items) {\n  const src = item.json ?? item;\n\n  // --- где взять yclid ---\n  let yclid = src.yclid ?? src.yclidid ?? null;\n\n  // из page_url (?yclid=...)\n  if (!notEmpty(yclid) && src.page_url) {\n    const q = getQueryParam(src.page_url, 'yclid');\n    if (notEmpty(q)) yclid = q;\n  }\n\n  // из custom_value_json (если там хранится)\n  if (!notEmpty(yclid) && src.custom_value_json) {\n    const cv = tryParseJSON(src.custom_value_json);\n    if (cv && typeof cv === 'object' && 'yclid' in cv && notEmpty(cv.yclid)) {\n      yclid = cv.yclid;\n    }\n  }\n\n  const newVal = notEmpty(yclid) ? 8 : 3;\n\n  // подменяем ВЕЗДЕ, где уже есть lead_source_id\n  const replaced = replaceLeadSourceId(src, newVal);\n\n  // лог для проверки\n  console.log({ resolved_yclid: yclid ?? null, new_lead_source_id: newVal, replaced_keys: replaced });\n\n  // если нужно также гарантированно обновить верхнеуровневое значение (которое ты показал в примере),\n  // и оно есть в корне — продублируем:\n  if ('lead_source_id' in src) {\n    src.lead_source_id = typeof src.lead_source_id === 'string' ? String(newVal) : newVal;\n  }\n\n  // записываем обратно в item\n  if (item.json) item.json = src; else Object.assign(item, src);\n}\n\nreturn items;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        800,
        0
      ],
      "id": "cdd34478-ee50-4557-997e-8864a9764def",
      "name": "update lead_source_id"
    },
    {
      "parameters": {
        "jsCode": "// Code (Function) node\n// Вход: $json.body = строка с JSON\n// Выход: нормальный объект, доступный далее как $json\nconst raw = $json.body || '';\nlet parsed = {};\ntry { parsed = JSON.parse(raw); } catch(e) {}\nreturn [{ ...parsed, _raw: raw }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        288,
        0
      ],
      "id": "01610508-3171-486f-83ee-268ac6fcafcf",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "jsCode": "/**\n * AlfaCRM create customer (n8n Code)\n * branch_ids = [1] (Саратов)\n * Телефон только в contact_contacts\n */\n\nasync function http(req) { return await this.helpers.httpRequest(req); }\n\nasync function login(self, { host, email, api_key }) {\n  const res = await http.call(self, {\n    method: 'POST',\n    url: `https://${host}/v2api/auth/login`,\n    headers: { 'Content-Type': 'application/json' },\n    body: { email, api_key },\n    json: true,\n  });\n  if (!res?.token) throw new Error('Auth failed');\n  return res.token;\n}\n\nasync function createCustomer(self, { host, token, payload }) {\n  try {\n    const res = await http.call(self, {\n      method: 'POST',\n      url: `https://${host}/v2api/1/customer/create`,\n      headers: {\n        'Content-Type': 'application/json',\n        'X-ALFACRM-TOKEN': token,\n      },\n      body: payload,\n      json: true,\n      gzip: true,\n      timeout: 20000,\n    });\n    return { success: true, response: res };\n  } catch (err) {\n    return {\n      success: false,\n      status: err?.response?.statusCode,\n      error: err?.response?.body || err.message,\n    };\n  }\n}\n\n// ---------- helpers ----------\nconst notEmpty = v => v !== undefined && v !== null && String(v).trim() !== '';\nconst toNum = v => {\n  if (!notEmpty(v)) return undefined;\n  const n = Number(String(v).trim());\n  return Number.isFinite(n) ? n : undefined;\n};\nfunction asObj(maybe) {\n  if (!maybe) return {};\n  if (typeof maybe === 'object') return maybe;\n  if (typeof maybe === 'string') {\n    try { return JSON.parse(maybe); } catch { return {}; }\n  }\n  return {};\n}\nfunction findKeyDeep(obj, keyMatcher) {\n  const seen = new Set();\n  const stack = [obj];\n  while (stack.length) {\n    const cur = stack.pop();\n    if (!cur || typeof cur !== 'object') continue;\n    if (seen.has(cur)) continue;\n    seen.add(cur);\n    if (Array.isArray(cur)) { for (const v of cur) stack.push(v); continue; }\n    for (const [k, v] of Object.entries(cur)) {\n      if (keyMatcher(k)) return v;\n      if (v && typeof v === 'object') stack.push(v);\n    }\n  }\n  return undefined;\n}\n\n// ---------- MAIN ----------\nconst items = await $input.all();\nconst out = [];\n\nfor (const item of items) {\n  const input = item.json ?? item;\n  const conf = input.alfacrm || {};\n\n  const host = conf.host || input.host;\n  const email = conf.email || input.email;\n  const api_key = conf.api_key || input.api_key;\n  if (!host || !email || !api_key) {\n    throw new Error('Provide alfacrm.host, alfacrm.email, alfacrm.api_key');\n  }\n\n  const token = await login(this, { host, email, api_key });\n\n  const lead_source_id =\n    toNum(findKeyDeep(input, k => k === 'lead_source_id')) ??\n    toNum(input.lead_source_id) ?? 3;\n\n  const f = asObj(input.fields);\n  const name  = f[\"1_2\"] || input.name || \"Без имени\";\n  const phone = String(f[\"1_3\"] || input.phone || \"\").trim();\n  const city  = f[\"1_7\"] || input.city || \"\";\n\n  const utm_source   = input.utm_source   || \"\";\n  const utm_medium   = input.utm_medium   || \"\";\n  const utm_campaign = input.utm_campaign || \"\";\n  const utm_content  = input.utm_content  || \"\";\n  const utm_term     = input.utm_term     || \"\";\n  const yclid        = input.yclid        || \"\";\n\n  const custom_value_json = JSON.stringify({\n    utm_source, utm_medium, utm_campaign, utm_content, utm_term, yclid,\n  });\n\n  const payload = {\n    name,\n    branch_ids: [1],\n    legal_type: 1,\n    is_study: 0,\n    lead_source_id,\n    ...(notEmpty(phone) ? { contact_contacts: [phone] } : {}),\n    ...(city ? { note: `Город: ${city}` } : {}),\n    ...(notEmpty(utm_source)   ? { custom_utm_source: utm_source } : {}),\n    ...(notEmpty(utm_medium)   ? { custom_utm_medium: utm_medium } : {}),\n    ...(notEmpty(utm_campaign) ? { custom_utm_campaign: utm_campaign } : {}),\n    ...(notEmpty(utm_content)  ? { custom_utm_content: utm_content } : {}),\n    ...(notEmpty(utm_term)     ? { custom_utm_term: utm_term } : {}),\n    ...(notEmpty(yclid)        ? { custom_yclid: yclid } : {}),\n    custom_value_json,\n  };\n\n  const res = await createCustomer(this, { host, token, payload });\n  out.push({ json: { success: res.success, response: res.response, sent: payload } });\n}\n\nreturn out;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1072,
        192
      ],
      "id": "f04389da-da52-4fed-93f6-99354e7af20a",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "{\n  \"alfacrm\": {\n    \"host\": \"kiberonesaratov.s20.online\",\n    \"email\": \"antonkarzhavin1@yandex.ru\",\n    \"api_key\": \"656b9709-9547-11f0-b9b8-3cecefbdd1ae\"\n  },\n  \"fields\": { \"1_2\": \"Антон Тест111\", \"1_3\": \"+381601111111\", \"1_7\": \"Саратов\" },\n  \"lead_source_id\": 8,\n  \"etext\": \"Кнопка «записаться»\",\n  \"utm_source\": \"yandex\",\n  \"utm_medium\": \"cpc\",\n  \"utm_campaign\": \"brand_search\",\n  \"utm_content\": \"cta_top\",\n  \"utm_term\": \"киберон саратов\",\n  \"yclid\": \"1234567890\"\n}",
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        640,
        144
      ],
      "id": "49a47b42-83c2-49da-b93c-377cf4b4216c",
      "name": "Set CRM data1"
    }
  ],
  "connections": {
    "Set CRM data": {
      "main": [
        [
          {
            "node": "update lead_source_id",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "update lead_source_id": {
      "main": [
        [
          {
            "node": "Send Lead data to CRM",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Set CRM data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Lead data to CRM": {
      "main": [
        []
      ]
    },
    "Set CRM data1": {
      "main": [
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": null,
  "pinData": {},
  "versionId": "8936a9c6-18b7-4c75-802f-6e5062e841c4",
  "triggerCount": 1,
  "shared": [
    {
      "createdAt": "2025-10-21T12:43:03.776Z",
      "updatedAt": "2025-10-21T12:43:03.776Z",
      "role": "workflow:owner",
      "workflowId": "Z5sOyh4IJtSVsD2a",
      "projectId": "spKmbJLU4mvACXIB"
    }
  ],
  "tags": []
}