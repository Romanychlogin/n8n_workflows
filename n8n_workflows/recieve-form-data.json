{
  "createdAt": "2025-10-21T12:43:03.776Z",
  "updatedAt": "2025-10-22T11:49:00.300Z",
  "id": "Z5sOyh4IJtSVsD2a",
  "name": "Recieve form data",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "add0a254-19eb-4e02-b02e-344a6f26a86e",
        "options": {
          "rawBody": true
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        0,
        0
      ],
      "id": "53703b18-b0c9-4def-a05e-6591c46fc7ec",
      "name": "Webhook",
      "webhookId": "add0a254-19eb-4e02-b02e-344a6f26a86e"
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "{\n  \"alfacrm\": {\n    \"host\": \"kiberonesaratov.s20.online\",\n    \"email\": \"antonkarzhavin1@yandex.ru\",\n    \"api_key\": \"656b9709-9547-11f0-b9b8-3cecefbdd1ae\",\n    \"lead_source_id\": 1,\n    \"branch_id\": 1,\n  }\n}",
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        512,
        0
      ],
      "id": "bfa32a75-2fb1-4ecb-a0f9-1c7e2982656c",
      "name": "Set CRM data"
    },
    {
      "parameters": {
        "jsCode": "/**\n * AlfaCRM create customer (n8n Code)\n * branch_ids = [1] (Саратов)\n * Телефон выбирается умно: 1_7, 1_3, phone, tel, потом глубокий поиск — берём первый валидный.\n * Пишем только в contact_contacts.\n */\n\nasync function http(req) { return await this.helpers.httpRequest(req); }\n\nasync function login(self, { host, email, api_key }) {\n  const res = await http.call(self, {\n    method: 'POST',\n    url: `https://${host}/v2api/auth/login`,\n    headers: { 'Content-Type': 'application/json' },\n    body: { email, api_key },\n    json: true,\n  });\n  if (!res?.token) throw new Error('Auth failed');\n  return res.token;\n}\n\nasync function createCustomer(self, { host, token, payload }) {\n  try {\n    const res = await http.call(self, {\n      method: 'POST',\n      url: `https://${host}/v2api/1/customer/create`,\n      headers: {\n        'Content-Type': 'application/json',\n        'X-ALFACRM-TOKEN': token,\n      },\n      body: payload,\n      json: true,\n      gzip: true,\n      timeout: 20000,\n    });\n    return { success: true, response: res };\n  } catch (err) {\n    return {\n      success: false,\n      status: err?.response?.statusCode,\n      error: err?.response?.body || err.message,\n    };\n  }\n}\n\n// ---------- helpers ----------\nconst notEmpty = v => v !== undefined && v !== null && String(v).trim() !== '';\nconst toNum = v => {\n  if (!notEmpty(v)) return undefined;\n  const n = Number(String(v).trim());\n  return Number.isFinite(n) ? n : undefined;\n};\nfunction asObj(maybe) {\n  if (!maybe) return {};\n  if (typeof maybe === 'object') return maybe;\n  if (typeof maybe === 'string') {\n    try { return JSON.parse(maybe); } catch { return {}; }\n  }\n  return {};\n}\nfunction findKeyDeep(obj, keyMatcher) {\n  const seen = new Set();\n  const stack = [obj];\n  while (stack.length) {\n    const cur = stack.pop();\n    if (!cur || typeof cur !== 'object') continue;\n    if (seen.has(cur)) continue;\n    seen.add(cur);\n    if (Array.isArray(cur)) { for (const v of cur) stack.push(v); continue; }\n    for (const [k, v] of Object.entries(cur)) {\n      if (keyMatcher(k)) return v;\n      if (v && typeof v === 'object') stack.push(v);\n    }\n  }\n  return undefined;\n}\n\n// нормализуем телефон: оставляем + и цифры, приводим к +XXXXXXXX, базовая валидация (>=8 цифр)\nfunction normalizePhone(raw) {\n  const s = String(raw || '').trim();\n  if (!s) return '';\n  let keep = s.replace(/[^\\d+]/g, '');\n\n  // превратим 00.. в +..\n  if (keep.startsWith('00')) keep = '+' + keep.slice(2);\n\n  // если начинается с 8 и всего 11 цифр — часто это РФ, приводим к +7\n  const digitsOnly = keep.replace(/\\D/g, '');\n  if (digitsOnly.length === 11 && keep[0] === '8') keep = '+7' + digitsOnly.slice(1);\n  if (keep[0] !== '+') keep = '+' + digitsOnly;\n\n  const finalDigits = keep.replace(/\\D/g, '');\n  if (finalDigits.length < 8 || finalDigits.length > 15) return '';\n  return keep;\n}\n\n// выбираем первый валидный номер из списка кандидатов; если не нашли — пробуем глубокий поиск по строкам\nfunction pickPhoneSmart(input) {\n  const f = asObj(input.fields);\n\n  const candidates = [\n    f['1_7'],            // у тебя бывает тут\n    f['1_3'],            // и бывает тут\n    input.phone,\n    input.tel,\n  ].filter(notEmpty);\n\n  for (const c of candidates) {\n    const n = normalizePhone(c);\n    if (n) return { phone: n, source: 'candidates', raw: c };\n  }\n\n  // глубокий поиск: собираем все строки, похожие на телефон\n  const seen = new Set(); const stack = [input];\n  while (stack.length) {\n    const cur = stack.pop();\n    if (!cur || typeof cur !== 'object') continue;\n    if (seen.has(cur)) continue; seen.add(cur);\n    if (Array.isArray(cur)) { for (const v of cur) stack.push(v); continue; }\n    for (const [k, v] of Object.entries(cur)) {\n      if (typeof v === 'string' && /[\\d)(\\-\\s+]{6,}/.test(v)) {\n        const n = normalizePhone(v);\n        if (n) return { phone: n, source: `deep:${k}`, raw: v };\n      }\n      if (v && typeof v === 'object') stack.push(v);\n    }\n  }\n  return { phone: '', source: null, raw: null };\n}\n\n// ---------- MAIN ----------\nconst items = await $input.all();\nconst out = [];\n\nfor (const item of items) {\n  const input = item.json ?? item;\n  const conf = input.alfacrm || {};\n\n  const host = conf.host || input.host;\n  const email = conf.email || input.email;\n  const api_key = conf.api_key || input.api_key;\n  if (!host || !email || !api_key) {\n    throw new Error('Provide alfacrm.host, alfacrm.email, alfacrm.api_key');\n  }\n\n  const token = await login(this, { host, email, api_key });\n\n  const lead_source_id =\n    toNum(findKeyDeep(input, k => k === 'lead_source_id')) ??\n    toNum(input.lead_source_id) ?? 3;\n\n  const f = asObj(input.fields);\n  const name  = f['1_2'] || input.name || 'Без имени';\n\n  // умный телефон\n  const { phone, source: phone_source, raw: phone_raw } = pickPhoneSmart(input);\n\n  // на заметку — город, если есть в полях (не трогаем 1_7, там у тебя часто телефон)\n  const city = f['city'] || input.city || '';\n\n  // UTM / yclid\n  const utm_source   = input.utm_source   || '';\n  const utm_medium   = input.utm_medium   || '';\n  const utm_campaign = input.utm_campaign || '';\n  const utm_content  = input.utm_content  || '';\n  const utm_term     = input.utm_term     || '';\n  const yclid        = input.yclid        || '';\n\n  const custom_value_json = JSON.stringify({\n    utm_source, utm_medium, utm_campaign, utm_content, utm_term, yclid,\n  });\n\n  const payload = {\n    name,\n    branch_ids: [1],\n    legal_type: 1,\n    is_study: 0,\n    lead_source_id,\n    ...(notEmpty(phone) ? { contact_contacts: [phone] } : {}),\n    ...(city ? { note: `Город: ${city}` } : {}),\n    ...(notEmpty(utm_source)   ? { custom_utm_source: utm_source } : {}),\n    ...(notEmpty(utm_medium)   ? { custom_utm_medium: utm_medium } : {}),\n    ...(notEmpty(utm_campaign) ? { custom_utm_campaign: utm_campaign } : {}),\n    ...(notEmpty(utm_content)  ? { custom_utm_content: utm_content } : {}),\n    ...(notEmpty(utm_term)     ? { custom_utm_term: utm_term } : {}),\n    ...(notEmpty(yclid)        ? { custom_yclid: yclid } : {}),\n    custom_value_json,\n  };\n\n  const res = await createCustomer(this, { host, token, payload });\n  out.push({\n    json: {\n      success: res.success,\n      response: res.response,\n      sent: payload,\n      debug_phone: { source: phone_source, raw: phone_raw, final: phone }\n    }\n  });\n}\n\nreturn out;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1056,
        0
      ],
      "id": "4d3da4ba-604a-465f-9de8-3a1d247a97f8",
      "name": "Send Lead data to CRM"
    },
    {
      "parameters": {
        "jsCode": "// n8n Code (JavaScript) — Run Once for All Items\nconst items = await $input.all();\n\n// --- helpers ---\nconst notEmpty = v => v !== undefined && v !== null && String(v).trim() !== '';\n\nfunction tryParseJSON(s) {\n  if (typeof s !== 'string') return s;\n  try { return JSON.parse(s); } catch { return s; }\n}\n\nfunction getQueryParam(url, name) {\n  try { return new URL(String(url)).searchParams.get(name); } catch { return null; }\n}\n\n/**\n * Рекурсивно находит ВСЕ ключи \"lead_source_id\" и подменяет значение.\n * Сохраняет тип: если раньше было \"40\" (string), запишет \"8\"/\"3\" как строку.\n * Возвращает количество замен.\n */\nfunction replaceLeadSourceId(obj, newValNumber) {\n  let count = 0;\n  const stack = [obj];\n  const seen = new Set();\n\n  while (stack.length) {\n    const cur = stack.pop();\n    if (!cur || typeof cur !== 'object') continue;\n    if (seen.has(cur)) continue;\n    seen.add(cur);\n\n    if (Array.isArray(cur)) {\n      for (const v of cur) if (v && typeof v === 'object') stack.push(v);\n      continue;\n    }\n\n    for (const [k, v] of Object.entries(cur)) {\n      if (k === 'lead_source_id') {\n        const keepString = typeof v === 'string';\n        cur[k] = keepString ? String(newValNumber) : newValNumber;\n        count++;\n      }\n      if (v && typeof v === 'object') stack.push(v);\n    }\n  }\n  return count;\n}\n\nfor (const item of items) {\n  const src = item.json ?? item;\n\n  // --- где взять yclid ---\n  let yclid = src.yclid ?? src.yclidid ?? null;\n\n  // из page_url (?yclid=...)\n  if (!notEmpty(yclid) && src.page_url) {\n    const q = getQueryParam(src.page_url, 'yclid');\n    if (notEmpty(q)) yclid = q;\n  }\n\n  // из custom_value_json (если там хранится)\n  if (!notEmpty(yclid) && src.custom_value_json) {\n    const cv = tryParseJSON(src.custom_value_json);\n    if (cv && typeof cv === 'object' && 'yclid' in cv && notEmpty(cv.yclid)) {\n      yclid = cv.yclid;\n    }\n  }\n\n  const newVal = notEmpty(yclid) ? 8 : 3;\n\n  // подменяем ВЕЗДЕ, где уже есть lead_source_id\n  const replaced = replaceLeadSourceId(src, newVal);\n\n  // лог для проверки\n  console.log({ resolved_yclid: yclid ?? null, new_lead_source_id: newVal, replaced_keys: replaced });\n\n  // если нужно также гарантированно обновить верхнеуровневое значение (которое ты показал в примере),\n  // и оно есть в корне — продублируем:\n  if ('lead_source_id' in src) {\n    src.lead_source_id = typeof src.lead_source_id === 'string' ? String(newVal) : newVal;\n  }\n\n  // записываем обратно в item\n  if (item.json) item.json = src; else Object.assign(item, src);\n}\n\nreturn items;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        800,
        0
      ],
      "id": "cdd34478-ee50-4557-997e-8864a9764def",
      "name": "update lead_source_id"
    },
    {
      "parameters": {
        "jsCode": "// Code (Function) node\n// Вход: $json.body = строка с JSON\n// Выход: нормальный объект, доступный далее как $json\nconst raw = $json.body || '';\nlet parsed = {};\ntry { parsed = JSON.parse(raw); } catch(e) {}\nreturn [{ ...parsed, _raw: raw }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        288,
        0
      ],
      "id": "01610508-3171-486f-83ee-268ac6fcafcf",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "jsCode": "/**\n * AlfaCRM create customer (n8n Code)\n * branch_ids = [1] (Саратов)\n * Телефон только в contact_contacts\n */\n\nasync function http(req) { return await this.helpers.httpRequest(req); }\n\nasync function login(self, { host, email, api_key }) {\n  const res = await http.call(self, {\n    method: 'POST',\n    url: `https://${host}/v2api/auth/login`,\n    headers: { 'Content-Type': 'application/json' },\n    body: { email, api_key },\n    json: true,\n  });\n  if (!res?.token) throw new Error('Auth failed');\n  return res.token;\n}\n\nasync function createCustomer(self, { host, token, payload }) {\n  try {\n    const res = await http.call(self, {\n      method: 'POST',\n      url: `https://${host}/v2api/1/customer/create`,\n      headers: {\n        'Content-Type': 'application/json',\n        'X-ALFACRM-TOKEN': token,\n      },\n      body: payload,\n      json: true,\n      gzip: true,\n      timeout: 20000,\n    });\n    return { success: true, response: res };\n  } catch (err) {\n    return {\n      success: false,\n      status: err?.response?.statusCode,\n      error: err?.response?.body || err.message,\n    };\n  }\n}\n\n// ---------- helpers ----------\nconst notEmpty = v => v !== undefined && v !== null && String(v).trim() !== '';\nconst toNum = v => {\n  if (!notEmpty(v)) return undefined;\n  const n = Number(String(v).trim());\n  return Number.isFinite(n) ? n : undefined;\n};\nfunction asObj(maybe) {\n  if (!maybe) return {};\n  if (typeof maybe === 'object') return maybe;\n  if (typeof maybe === 'string') {\n    try { return JSON.parse(maybe); } catch { return {}; }\n  }\n  return {};\n}\nfunction findKeyDeep(obj, keyMatcher) {\n  const seen = new Set();\n  const stack = [obj];\n  while (stack.length) {\n    const cur = stack.pop();\n    if (!cur || typeof cur !== 'object') continue;\n    if (seen.has(cur)) continue;\n    seen.add(cur);\n    if (Array.isArray(cur)) { for (const v of cur) stack.push(v); continue; }\n    for (const [k, v] of Object.entries(cur)) {\n      if (keyMatcher(k)) return v;\n      if (v && typeof v === 'object') stack.push(v);\n    }\n  }\n  return undefined;\n}\n\n// ---------- MAIN ----------\nconst items = await $input.all();\nconst out = [];\n\nfor (const item of items) {\n  const input = item.json ?? item;\n  const conf = input.alfacrm || {};\n\n  const host = conf.host || input.host;\n  const email = conf.email || input.email;\n  const api_key = conf.api_key || input.api_key;\n  if (!host || !email || !api_key) {\n    throw new Error('Provide alfacrm.host, alfacrm.email, alfacrm.api_key');\n  }\n\n  const token = await login(this, { host, email, api_key });\n\n  const lead_source_id =\n    toNum(findKeyDeep(input, k => k === 'lead_source_id')) ??\n    toNum(input.lead_source_id) ?? 3;\n\n  const f = asObj(input.fields);\n  const name  = f[\"1_2\"] || input.name || \"Без имени\";\n  const phone = String(f[\"1_3\"] || input.phone || \"\").trim();\n  const city  = f[\"1_7\"] || input.city || \"\";\n\n  const utm_source   = input.utm_source   || \"\";\n  const utm_medium   = input.utm_medium   || \"\";\n  const utm_campaign = input.utm_campaign || \"\";\n  const utm_content  = input.utm_content  || \"\";\n  const utm_term     = input.utm_term     || \"\";\n  const yclid        = input.yclid        || \"\";\n\n  const custom_value_json = JSON.stringify({\n    utm_source, utm_medium, utm_campaign, utm_content, utm_term, yclid,\n  });\n\n  const payload = {\n    name,\n    branch_ids: [1],\n    legal_type: 1,\n    is_study: 0,\n    lead_source_id,\n    ...(notEmpty(phone) ? { contact_contacts: [phone] } : {}),\n    ...(city ? { note: `Город: ${city}` } : {}),\n    ...(notEmpty(utm_source)   ? { custom_utm_source: utm_source } : {}),\n    ...(notEmpty(utm_medium)   ? { custom_utm_medium: utm_medium } : {}),\n    ...(notEmpty(utm_campaign) ? { custom_utm_campaign: utm_campaign } : {}),\n    ...(notEmpty(utm_content)  ? { custom_utm_content: utm_content } : {}),\n    ...(notEmpty(utm_term)     ? { custom_utm_term: utm_term } : {}),\n    ...(notEmpty(yclid)        ? { custom_yclid: yclid } : {}),\n    custom_value_json,\n  };\n\n  const res = await createCustomer(this, { host, token, payload });\n  out.push({ json: { success: res.success, response: res.response, sent: payload } });\n}\n\nreturn out;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1072,
        192
      ],
      "id": "f04389da-da52-4fed-93f6-99354e7af20a",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "{\n  \"alfacrm\": {\n    \"host\": \"kiberonesaratov.s20.online\",\n    \"email\": \"antonkarzhavin1@yandex.ru\",\n    \"api_key\": \"656b9709-9547-11f0-b9b8-3cecefbdd1ae\"\n  },\n  \"fields\": { \"1_2\": \"Антон Тест111\", \"1_3\": \"+381601111111\", \"1_7\": \"Саратов\" },\n  \"lead_source_id\": 8,\n  \"etext\": \"Кнопка «записаться»\",\n  \"utm_source\": \"yandex\",\n  \"utm_medium\": \"cpc\",\n  \"utm_campaign\": \"brand_search\",\n  \"utm_content\": \"cta_top\",\n  \"utm_term\": \"киберон саратов\",\n  \"yclid\": \"1234567890\"\n}",
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        640,
        144
      ],
      "id": "49a47b42-83c2-49da-b93c-377cf4b4216c",
      "name": "Set CRM data1"
    }
  ],
  "connections": {
    "Set CRM data": {
      "main": [
        [
          {
            "node": "update lead_source_id",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "update lead_source_id": {
      "main": [
        [
          {
            "node": "Send Lead data to CRM",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Set CRM data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Lead data to CRM": {
      "main": [
        []
      ]
    },
    "Set CRM data1": {
      "main": [
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": null,
  "pinData": {},
  "versionId": "67829a1b-b947-4cfa-bd47-a93cd4321a3a",
  "triggerCount": 1,
  "shared": [
    {
      "createdAt": "2025-10-21T12:43:03.776Z",
      "updatedAt": "2025-10-21T12:43:03.776Z",
      "role": "workflow:owner",
      "workflowId": "Z5sOyh4IJtSVsD2a",
      "projectId": "spKmbJLU4mvACXIB"
    }
  ],
  "tags": []
}