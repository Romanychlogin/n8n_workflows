{
  "updatedAt": "2025-11-25T14:34:22.518Z",
  "createdAt": "2025-11-25T09:38:54.462Z",
  "id": "rqGW2HVOvVPX4TMA",
  "name": "key_words_with_services_analysis_batches",
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "inputSource": "passthrough"
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -2192,
        -208
      ],
      "id": "06243399-9573-4f07-a09e-e1aba578dd3a",
      "name": "When Executed by Another Workflow"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO business_processes_states (business_process_id, company_id,n8n_workflow_execution_id,n8n_workflow_root_execution_id, started)\nSELECT MAX(business_process_id), $2,$3,$4, NOW()\nFROM public.business_processes\nWHERE n8n_process_name = $1;",
        "options": {
          "queryReplacement": "=[{{$workflow.name}},{{$json.company_id}},{{$execution.id}},{{ $('When Executed by Another Workflow').item.json.root_execution_id }}]"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1968,
        -192
      ],
      "id": "0f599f7e-54b6-400a-9e4f-40aa2c9deb5d",
      "name": "Mark_workwlow_started",
      "credentials": {
        "postgres": {
          "id": "4YkdFJcdTgzo9hkz",
          "name": "PGvector"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "update business_processes_states set finished=NOW(),steps_passed=steps_total where  n8n_workflow_execution_id=$1",
        "options": {
          "queryReplacement": "={{$execution.id}}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2608,
        -992
      ],
      "id": "d57b7f33-38f2-41dc-9b69-3897f5a245a5",
      "name": "Mark_workflow_completed",
      "executeOnce": true,
      "credentials": {
        "postgres": {
          "id": "4YkdFJcdTgzo9hkz",
          "name": "PGvector"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "update business_processes_states set steps_total=$2 where  n8n_workflow_execution_id=$1",
        "options": {
          "queryReplacement": "=[{{$execution.id}},{{$input.all().length}}]"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1344,
        -16
      ],
      "id": "4c2e7978-5f49-437f-a27f-3de9ad50ae4c",
      "name": "Mark_workflow_total_steps",
      "executeOnce": true,
      "alwaysOutputData": false,
      "credentials": {
        "postgres": {
          "id": "4YkdFJcdTgzo9hkz",
          "name": "PGvector"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Function-Node (Run Once)\nconst workflowData = $getWorkflowStaticData('global');\nworkflowData.steps_passed = 0;\nworkflowData.tokens_used = 0;\nreturn $input.all();\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1152,
        -32
      ],
      "id": "e5c0524f-d44d-4d4d-b4ea-3b9b4bc0c514",
      "name": "Init total counter"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d27c7f74-161b-428a-9631-a094ab1327bc",
              "name": "batch_size",
              "value": "100",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1776,
        -192
      ],
      "id": "dd1d4933-3917-4659-b46f-aedc5700f1ff",
      "name": "batch_size"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "select count(*) as total from key_words where company_id=$1 and is_relevant is null and resolution_type is null\n\n",
        "options": {
          "queryReplacement": "={{ $('When Executed by Another Workflow').item.json.company_id }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -688,
        -176
      ],
      "id": "65394146-e432-4158-9cc2-e0fbd8804b79",
      "name": "Get not processes keys1",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "Hx2VFmUi5WO2K4QX",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "2e2f60c0-84c7-45d5-bf94-ea01d57abca6",
              "leftValue": "={{ $json.total}}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -64,
        -240
      ],
      "id": "6dea8019-a817-453e-9706-44cfb5dcd076",
      "name": "If"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "AEZDBlqe199xBn5u",
          "mode": "list",
          "cachedResultUrl": "/workflow/AEZDBlqe199xBn5u",
          "cachedResultName": "key_words_with_services_analysis"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {}
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        400,
        96
      ],
      "id": "20815957-d241-4c87-9b24-2f27d50f0795",
      "name": "Call 'key_words_with_services_analysis'"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "AEZDBlqe199xBn5u",
          "mode": "list",
          "cachedResultUrl": "/workflow/AEZDBlqe199xBn5u",
          "cachedResultName": "key_words_with_services_analysis"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {}
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        480,
        -64
      ],
      "id": "7b66f521-b8bc-4067-8369-18a0c07437c6",
      "name": "Call 'key_words_with_services_analysis'1"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "AEZDBlqe199xBn5u",
          "mode": "list",
          "cachedResultUrl": "/workflow/AEZDBlqe199xBn5u",
          "cachedResultName": "key_words_with_services_analysis"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {}
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        688,
        -176
      ],
      "id": "b7662424-4a27-4474-80cb-34ac3438ef66",
      "name": "Call 'key_words_with_services_analysis'2"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "select CEIL(CAST(COUNT(*) AS decimal(10,2))/$2) as total from key_words where company_id=$1 and is_relevant is null and resolution_type is null\n",
        "options": {
          "queryReplacement": "={{ $('When Executed by Another Workflow').item.json.company_id }},{{ $json.batch_size }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1552,
        -16
      ],
      "id": "f7e5a9c5-5388-40e1-958e-c2a2233750a9",
      "name": "Get not processes keys",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "Hx2VFmUi5WO2K4QX",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "mode": "chooseBranch"
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -944,
        -240
      ],
      "id": "5dad1fdf-a645-4477-b2ae-2edcc3acaef9",
      "name": "Merge1"
    },
    {
      "parameters": {
        "errorMessage": "Process terminated by user"
      },
      "type": "n8n-nodes-base.stopAndError",
      "typeVersion": 1,
      "position": [
        4064,
        0
      ],
      "id": "2a7ffc44-062c-4edb-9d84-97291b9a9a3f",
      "name": "Stop and Error"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "business_processes_states",
          "mode": "list",
          "cachedResultName": "business_processes_states"
        },
        "returnAll": true,
        "where": {
          "values": [
            {
              "column": "n8n_workflow_execution_id",
              "value": "={{ $execution.id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2896,
        144
      ],
      "id": "bb133169-f5a7-4be3-8f43-41550acf5aec",
      "name": "check if termination is requested",
      "credentials": {
        "postgres": {
          "id": "4YkdFJcdTgzo9hkz",
          "name": "PGvector"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "update business_processes_states set steps_passed=$2, tokens_used=0 where n8n_workflow_execution_id=$1",
        "options": {
          "queryReplacement": "=[{{$execution.id}},{{$json.steps_passed}}]"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2656,
        128
      ],
      "id": "767cb9d0-093f-46c3-8736-8ff9f38926be",
      "name": "Mark_workflow_passed_steps1",
      "executeOnce": true,
      "credentials": {
        "postgres": {
          "id": "4YkdFJcdTgzo9hkz",
          "name": "PGvector"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "fa13510a-3a56-4cd5-8b80-3e4fe626ce0b",
              "leftValue": "={{ $json.to_terminate }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3168,
        192
      ],
      "id": "cfbe1c3e-097f-418d-9fc6-d1c7b071d55d",
      "name": "If1"
    },
    {
      "parameters": {
        "mode": "chooseBranch",
        "numberInputs": 3
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        944,
        16
      ],
      "id": "577f5e48-7d34-483a-a6c5-cca2c6d3b523",
      "name": "Merge"
    },
    {
      "parameters": {
        "jsCode": "// Loop over input items and add a new field called 'myNewField' to the JSON of each one\nconst workflowData = $getWorkflowStaticData('global');\nworkflowData.steps_passed+=3; \nfor (const item of $input.all()) {\n  item.json.steps_passed = workflowData.steps_passed;\n}\n\n\nreturn $input.all();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2240,
        80
      ],
      "id": "b6f8b8c6-c3fa-4348-a8ab-2854292aeb37",
      "name": "Get current step saved3"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "bb81b51b-61c4-4492-9b76-83995759e824",
              "name": "root_execution_id",
              "value": "={{ $execution.id }}",
              "type": "number"
            },
            {
              "id": "321371a0-e2d9-4f50-a4e9-75f992b83751",
              "name": "company_id",
              "value": "={{ $('When Executed by Another Workflow').item.json.company_id }}",
              "type": "number"
            },
            {
              "id": "4dc56f45-8f0a-455e-ae90-1439f55d94ae",
              "name": "is_initial",
              "value": "={{ $('When Executed by Another Workflow').item.json.is_initial }}",
              "type": "boolean"
            },
            {
              "id": "4aae392f-eb27-4103-bcf6-f5dbe72488c5",
              "name": "batch_size",
              "value": "={{ $('batch_size').item.json.batch_size }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        160,
        -176
      ],
      "id": "775925ac-e662-4bf2-ac37-96554aad0ea2",
      "name": "set input"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "select count(*) as total from key_words where company_id=$1 and resolution_type='in_progress'",
        "options": {
          "queryReplacement": "={{ $('When Executed by Another Workflow').item.json.company_id }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1472,
        64
      ],
      "id": "a6b1c301-9cf7-4396-ac74-82a3d78e9d9f",
      "name": "Execute a SQL query",
      "credentials": {
        "postgres": {
          "id": "Hx2VFmUi5WO2K4QX",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        1248,
        48
      ],
      "id": "8976f521-05d9-4c7c-a9a6-c94f6594175f",
      "name": "Wait",
      "webhookId": "3b083385-6805-46fb-9d12-56146db3a974"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "63159f28-11b1-47c5-b01d-7d6f999199e3",
              "leftValue": "={{ $json.total}}",
              "rightValue": "0",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1680,
        64
      ],
      "id": "7733b7d2-7673-400d-9454-56017c6145cb",
      "name": "If2"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        1888,
        160
      ],
      "id": "ed065d36-9595-408d-bf42-bb1c491e016c",
      "name": "Wait1",
      "webhookId": "0019e73b-7c98-4ee2-8cad-09bc91a4d478"
    }
  ],
  "connections": {
    "When Executed by Another Workflow": {
      "main": [
        [
          {
            "node": "Mark_workwlow_started",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mark_workwlow_started": {
      "main": [
        [
          {
            "node": "batch_size",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mark_workflow_total_steps": {
      "main": [
        [
          {
            "node": "Init total counter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Init total counter": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "batch_size": {
      "main": [
        [
          {
            "node": "Get not processes keys",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get not processes keys1": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Mark_workflow_completed",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "set input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call 'key_words_with_services_analysis'": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Call 'key_words_with_services_analysis'2": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call 'key_words_with_services_analysis'1": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Get not processes keys": {
      "main": [
        [
          {
            "node": "Mark_workflow_total_steps",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge1": {
      "main": [
        [
          {
            "node": "Get not processes keys1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check if termination is requested": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mark_workflow_passed_steps1": {
      "main": [
        [
          {
            "node": "check if termination is requested",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Stop and Error",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get not processes keys1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get current step saved3": {
      "main": [
        [
          {
            "node": "Mark_workflow_passed_steps1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "set input": {
      "main": [
        [
          {
            "node": "Call 'key_words_with_services_analysis'2",
            "type": "main",
            "index": 0
          },
          {
            "node": "Call 'key_words_with_services_analysis'1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Call 'key_words_with_services_analysis'",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute a SQL query": {
      "main": [
        [
          {
            "node": "If2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Execute a SQL query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If2": {
      "main": [
        [
          {
            "node": "Get current step saved3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Wait1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait1": {
      "main": [
        [
          {
            "node": "Execute a SQL query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "none",
    "saveExecutionProgress": false,
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false,
    "errorWorkflow": "v2Z32ISEUzsFYnZw"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {
    "When Executed by Another Workflow": [
      {
        "json": {
          "id": "ezK8ihYnfxZNTIAc",
          "root_execution_id": 20076,
          "company_id": 1,
          "is_initial": "false"
        }
      }
    ]
  },
  "versionId": "fc760c2b-7073-41e7-bec5-9420cd8b766f",
  "triggerCount": 0,
  "shared": [
    {
      "updatedAt": "2025-11-25T09:38:54.462Z",
      "createdAt": "2025-11-25T09:38:54.462Z",
      "role": "workflow:owner",
      "workflowId": "rqGW2HVOvVPX4TMA",
      "projectId": "spKmbJLU4mvACXIB"
    }
  ],
  "tags": [
    {
      "updatedAt": "2025-10-17T09:03:18.269Z",
      "createdAt": "2025-10-17T09:03:18.269Z",
      "id": "S7zerj1h6Ro25pTA",
      "name": "client creation"
    }
  ]
}