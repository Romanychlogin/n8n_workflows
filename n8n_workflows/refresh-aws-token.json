{
  "updatedAt": "2025-11-12T14:54:15.527Z",
  "createdAt": "2025-11-11T17:33:50.959Z",
  "id": "KDJtWKBxL9g3ZqJp",
  "name": "refresh AWS token",
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 12
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        0,
        0
      ],
      "id": "e7a214fe-8354-4f90-944f-18b1d40f366d",
      "name": "Schedule Trigger"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://h9mv0vfn6j.execute-api.us-east-1.amazonaws.com/development/auth/refresh",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpCustomAuth",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        208,
        0
      ],
      "id": "003f5b69-1f93-44b0-b06a-6389ba41b64b",
      "name": "HTTP Request",
      "credentials": {
        "httpBearerAuth": {
          "id": "LTx5lBGpYHCJ3Jmp",
          "name": "AWS refresh token"
        },
        "httpCustomAuth": {
          "id": "4UQBP9BEeOsV3Iel",
          "name": "AWS refresh"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\nconst token = String($input.first().json.refresh_token ?? '').trim();\nif (!token) throw new Error('refresh_token отсутствует');\n\nconst customJson = {\n  headers: {'Content-Type': 'application/json' },\n   body: { 'refresh_token': token },\n};\n\n// Вариант А (надёжный): поле Data ожидает строку JSON\nfor (const item of items) {\n  item.json.creds_data_str = JSON.stringify({ json: JSON.stringify(customJson) });\n}\n\nreturn items;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        416,
        0
      ],
      "id": "996f96f5-1be8-4588-8ae7-945fcf1d1743",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "resource": "credential",
        "name": "AWS refresh",
        "credentialTypeName": "httpCustomAuth",
        "data": "={{ $('Code in JavaScript1').item.json.creds_data_str }}",
        "requestOptions": {}
      },
      "type": "n8n-nodes-base.n8n",
      "typeVersion": 1,
      "position": [
        912,
        -16
      ],
      "id": "d6ea2487-322f-4622-bc97-6e6f39f2ae91",
      "name": "Create a credential",
      "credentials": {
        "n8nApi": {
          "id": "WLaJZQv44MOJEghD",
          "name": "n8n account"
        }
      }
    },
    {
      "parameters": {
        "resource": "credential",
        "operation": "delete",
        "credentialId": "4UQBP9BEeOsV3Iel",
        "requestOptions": {}
      },
      "type": "n8n-nodes-base.n8n",
      "typeVersion": 1,
      "position": [
        672,
        -16
      ],
      "id": "41f7b748-9505-45e2-b71a-24acccb8cacd",
      "name": "Delete a credential",
      "credentials": {
        "n8nApi": {
          "id": "WLaJZQv44MOJEghD",
          "name": "n8n account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "DO $$\nDECLARE\n  v_name   text := 'AWS refresh';\n  v_new_id text := '4UQBP9BEeOsV3Iel';\n  v_old_id text;\n  v_tmp_name text;\nBEGIN\n  -- блокируем таблицы от конкурентных изменений на время операции\n  LOCK TABLE public.credentials_entity  IN SHARE ROW EXCLUSIVE MODE;\n  LOCK TABLE public.shared_credentials   IN SHARE ROW EXCLUSIVE MODE;\n\n  -- 1) находим исходный id по имени (если имён несколько — берём самый «свежий»)\n  SELECT id\n    INTO v_old_id\n  FROM public.credentials_entity\n  WHERE name = v_name\n  ORDER BY \"updatedAt\" DESC NULLS LAST, \"createdAt\" DESC NULLS LAST\n  LIMIT 1\n  FOR UPDATE;\n\n  IF v_old_id IS NULL THEN\n    RAISE EXCEPTION 'Credential with name \"%\" not found', v_name;\n  END IF;\n\n  IF v_old_id = v_new_id THEN\n    -- уже перенесено\n    RETURN;\n  END IF;\n\n  -- проверим, что нового ID ещё нет\n  IF EXISTS (SELECT 1 FROM public.credentials_entity WHERE id = v_new_id) THEN\n    RAISE EXCEPTION 'Target id \"%\" already exists in credentials_entity', v_new_id;\n  END IF;\n\n  -- 2) создаём «нового родителя» с TEMP-именем (на случай уникальности по name)\n  v_tmp_name := v_name || ' (tmp ' || substr(md5(random()::text),1,6) || ')';\n\n  INSERT INTO public.credentials_entity (id, name, data, type, \"createdAt\", \"updatedAt\", \"isManaged\")\n  SELECT v_new_id, v_tmp_name, ce.data, ce.type, ce.\"createdAt\", NOW(), ce.\"isManaged\"\n  FROM public.credentials_entity ce\n  WHERE ce.id = v_old_id;\n\n  -- 3) перевязываем все ссылки ребёнка на новый id\n  UPDATE public.shared_credentials sc\n  SET \"credentialsId\" = v_new_id,\n      \"updatedAt\"     = NOW()\n  WHERE sc.\"credentialsId\" = v_old_id;\n\n  -- 4) удаляем старого «родителя»\n  DELETE FROM public.credentials_entity\n  WHERE id = v_old_id;\n\n  -- 5) возвращаем исходное имя новой записи\n  UPDATE public.credentials_entity\n  SET name = v_name,\n      \"updatedAt\" = NOW()\n  WHERE id = v_new_id;\nEND $$;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1136,
        -32
      ],
      "id": "e2e1bb0c-65b1-4906-94c0-6c0d85737c9a",
      "name": "Execute a SQL query",
      "credentials": {
        "postgres": {
          "id": "hNuVeLeeeSX0vLBj",
          "name": "n8n service"
        }
      }
    }
  ],
  "connections": {
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "Delete a credential",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create a credential": {
      "main": [
        [
          {
            "node": "Execute a SQL query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete a credential": {
      "main": [
        [
          {
            "node": "Create a credential",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {},
  "versionId": "1e9497ec-492b-4aca-8e78-968ea493dcb9",
  "triggerCount": 0,
  "shared": [
    {
      "updatedAt": "2025-11-11T17:33:50.959Z",
      "createdAt": "2025-11-11T17:33:50.959Z",
      "role": "workflow:owner",
      "workflowId": "KDJtWKBxL9g3ZqJp",
      "projectId": "spKmbJLU4mvACXIB"
    }
  ],
  "tags": [
    {
      "updatedAt": "2025-10-07T08:31:00.329Z",
      "createdAt": "2025-10-07T08:31:00.329Z",
      "id": "mr0GomgPqPG1HJmt",
      "name": "core management"
    }
  ]
}