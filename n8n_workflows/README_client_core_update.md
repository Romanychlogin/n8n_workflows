# Client Core Update Workflow

## Описание

`client_core_update` - это основной workflow для управления всеми процессами анализа результатов отчета Яндекса по ключевым словам. Он объединяет в себе все необходимые шаги для полного анализа рекламной кампании.

## Назначение

- **Централизованное управление**: Единая точка входа для всех процессов анализа
- **Мониторинг**: Полная интеграция с системой мониторинга и логирования
- **Автоматизация**: Автоматическое выполнение всех необходимых шагов
- **Отказоустойчивость**: Проверка уже выполненных процессов и восстановление после ошибок

## Основные этапы

### 1. Инициализация (Шаги 1-3)
- Установка входных параметров
- Создание записи в `business_processes_states`
- Инициализация счетчика шагов

### 2. Подготовка данных (Шаги 4-6)
- Очистка временных таблиц
- Загрузка CSV отчета кампании
- Извлечение и вставка данных в `current_list`

### 3. Анализ кампании (Шаги 7-8)
- Вызов `ADV_campaign_analysis`
- Анализ релевантности и поиск минус-слов
- Обновление статуса записей

### 4. Анализ Wordstat (Шаги 9-10)
- Вызов `wordstat-xmlriver`
- Получение статистики по ключевым словам
- Обновление `wordstat_count`

### 5. Создание объявлений (Шаги 11-12)
- Вызов `ads-headers-and-texts-creation`
- Генерация заголовков и текстов
- Создание URL с UTM-метками

## Входные параметры

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `company_name` | string | Да | Название компании |
| `company_id` | number | Да | ID компании в базе данных |
| `campaign_report_url` | string | Да | URL CSV файла с отчетом кампании |
| `threshold` | number | Нет | Порог схожести для анализа (по умолчанию 0.88) |
| `yandex_region` | string | Нет | Регион для Яндекс.Директ (по умолчанию "53") |

## Выходные данные

- **current_list**: Обновленные данные с результатами анализа
- **current_minus_words**: Найденные минус-слова
- **ads_list**: Сгенерированные рекламные объявления
- **key_words**: Статистика по ключевым словам

## Мониторинг

### Отслеживание прогресса
- Каждый шаг обновляется в `business_processes_states`
- Счетчик шагов: `steps_passed` / `steps_total`
- Время выполнения: `started` - `finished`

### Уведомления
- **Ошибки**: Мгновенные уведомления в Telegram канал инцидентов
- **Статус**: Регулярные уведомления о прогрессе
- **Завершение**: Уведомление о успешном завершении

### Логирование
- Использование токенов OpenAI
- Время выполнения каждого шага
- Детали ошибок для отладки

## Использование

### Запуск workflow
1. Откройте workflow в n8n
2. Нажмите "Execute workflow"
3. Укажите необходимые параметры
4. Дождитесь завершения процесса

### Мониторинг выполнения
- Проверьте статус в Telegram каналах
- Просмотрите логи в `business_processes_states`
- Используйте `to_terminate` для принудительной остановки

## Обработка ошибок

### Автоматическое восстановление
- Проверка уже выполненных подпроцессов
- Пропуск успешно завершенных шагов
- Возможность продолжения с места остановки

### Ручное вмешательство
- Установка флага `to_terminate` для остановки
- Ручной запуск отдельных подпроцессов
- Анализ логов для диагностики проблем

## Версии

### client_core_update.json
- Базовая версия с основными функциями
- Подходит для большинства случаев
- Минимальные требования к ресурсам

### client_core_update_full.json
- Расширенная версия с дополнительными проверками
- Детальное логирование каждого шага
- Валидация результатов
- Рекомендуется для критически важных клиентов

## Интеграция с другими workflow

### Вызываемые workflow
- `ADV_campaign_analysis`: Анализ релевантности и поиск минус-слов
- `wordstat-xmlriver`: Получение статистики ключевых слов
- `ads-headers-and-texts-creation`: Генерация рекламных объявлений

### Зависимости
- База данных PostgreSQL с PGVector
- OpenAI API для анализа
- XMLRiver API для Wordstat
- Dropbox для хранения файлов

## Технические требования

- n8n версии 1.0+
- PostgreSQL с расширением PGVector
- Доступ к OpenAI API
- Доступ к XMLRiver API
- Доступ к Dropbox API

## Поддержка

При возникновении проблем:
1. Проверьте логи в `business_processes_states`
2. Убедитесь в доступности всех внешних API
3. Проверьте корректность входных параметров
4. Обратитесь к администратору системы

