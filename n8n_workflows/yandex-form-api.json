{
  "updatedAt": "2025-11-10T18:09:02.675Z",
  "createdAt": "2025-11-10T10:12:13.473Z",
  "id": "fsy7TJJRLJ5nc0Fc",
  "name": "yandex form API",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "7761af7e-68c6-4e99-ab82-e3acfdc463bc",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -272,
        0
      ],
      "id": "d3beae44-1400-44d8-8010-8ecbae0b2f2c",
      "name": "Webhook",
      "webhookId": "d0b73f09-ea23-4cd3-a92c-db7497c60763"
    },
    {
      "parameters": {
        "options": {
          "responseCode": 200,
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "https://trylesson.storage.yandexcloud.net"
              },
              {
                "name": "Vary",
                "value": "Origin"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        -48,
        0
      ],
      "id": "a2712e29-ad95-4946-ae6c-bc49b0a3914e",
      "name": "Respond to Webhook1"
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "{\n  \"alfacrm\": {\n    \"host\": \"kiberonesaratov.s20.online\",\n    \"email\": \"kiberone.saratov@gmail.com\",\n    \"api_key\": \"0bc94111-6567-11f0-b9b8-3cecefbdd1ae\",\n    \"branch_id\" : 1,\n  }\n}",
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        160,
        0
      ],
      "id": "42a54067-a57c-4667-ad1c-e7cc9d4c9851",
      "name": "Set CRM data"
    },
    {
      "parameters": {
        "jsCode": "async function http(req) { return await this.helpers.httpRequest(req); }\n\nasync function login(self, { host, email, api_key }) {\n  const res = await http.call(self, {\n    method: 'POST',\n    url: `https://${host}/v2api/auth/login`,\n    headers: { 'Content-Type': 'application/json' },\n    body: { email, api_key },\n    json: true,\n  });\n  if (!res?.token) throw new Error('Auth failed');\n  return res.token;\n}\n\nasync function createCustomer(self, { host, token, payload }) {\n  try {\n    const res = await http.call(self, {\n      method: 'POST',\n      url: `https://${host}/v2api/1/customer/create`,\n      headers: {\n        'Content-Type': 'application/json',\n        'X-ALFACRM-TOKEN': token,\n      },\n      body: payload,\n      json: true,\n      gzip: true,\n      timeout: 20000,\n    });\n    return { success: true, response: res };\n  } catch (err) {\n    return {\n      success: false,\n      status: err?.response?.statusCode,\n      error: err?.response?.body || err.message,\n    };\n  }\n}\n\n// ---------- helpers ----------\nconst notEmpty = v => v !== undefined && v !== null && String(v).trim() !== '';\nconst toNum = v => {\n  if (!notEmpty(v)) return undefined;\n  const n = Number(String(v).trim());\n  return Number.isFinite(n) ? n : undefined;\n};\nfunction asObj(maybe) {\n  if (!maybe) return {};\n  if (typeof maybe === 'object') return maybe;\n  if (typeof maybe === 'string') {\n    try { return JSON.parse(maybe); } catch { return {}; }\n  }\n  return {};\n}\nfunction firstNonEmpty(arr) {\n  for (const v of arr) if (notEmpty(v)) return String(v).trim();\n  return '';\n}\n\n// нормализуем телефон: оставляем + и цифры, приводим к +XXXXXXXX, базовая валидация (8..15 цифр)\nfunction normalizePhone(raw) {\n  const s = String(raw || '').trim();\n  if (!s) return '';\n  let keep = s.replace(/[^\\d+]/g, '');\n\n  if (keep.startsWith('00')) keep = '+' + keep.slice(2);\n\n  const digitsOnly = keep.replace(/\\D/g, '');\n  if (digitsOnly.length === 11 && keep[0] === '8') keep = '+7' + digitsOnly.slice(1);\n  if (keep[0] !== '+') keep = '+' + digitsOnly;\n\n  const finalDigits = keep.replace(/\\D/g, '');\n  if (finalDigits.length < 8 || finalDigits.length > 15) return '';\n  return keep;\n}\n\nfunction buildNote({ message, city }) {\n  const lines = [];\n  if (notEmpty(message)) lines.push(`Сообщение: ${message}`);\n  if (notEmpty(city))     lines.push(`Город: ${city}`);\n  return lines.join('\\n');\n}\n\n// ---------- MAIN ----------\nconst items = await $input.all();\nconst out = [];\n\nfor (const item of items) {\n  const input = item.json ?? item;\n  const conf = input.alfacrm || {};\n\n  // email здесь — только для авторизации\n  const host    = conf.host  || input.host;\n  const apiMail = conf.email || input.email;\n  const api_key = conf.api_key || input.api_key;\n  if (!host || !apiMail || !api_key) {\n    throw new Error('Provide alfacrm.host, alfacrm.email, alfacrm.api_key');\n  }\n\n  const token = await login(this, { host, email: apiMail, api_key });\n  const lead_source_id = toNum(input.lead_source_id) ?? 3;\n\n  // реальные данные формы приходят в body.*\n  const src = input.body ?? input;\n\n  // ===== Маппинг =====\n  const childName  = firstNonEmpty([ src.child_name, src['child name'] ]) || 'Без имени';\n  const parentName = firstNonEmpty([ src.parent_name ]);\n\n  // dob: БЕЗ каких-либо преобразований или trim — как пришло, так и уходит\n  const dobRawExists = Object.prototype.hasOwnProperty.call(src, 'child_birthdate');\n  const dob_raw_value = dobRawExists ? src.child_birthdate : undefined;\n  const dob_type = typeof dob_raw_value;\n  const dob = dob_raw_value; // ← отправляем как есть\n\n  const phoneRaw   = firstNonEmpty([ src.phone ]);\n  const phone      = normalizePhone(phoneRaw);\n  const emailForm  = firstNonEmpty([ src.email ]);\n\n  // contact_contacts — массив, только телефон\n  const contact_contacts = [phone].filter(notEmpty);\n  // email — отдельный массив\n  const emailArr = [emailForm].filter(notEmpty);\n\n  const message = firstNonEmpty([ src.message ]);\n  const city    = firstNonEmpty([ src.city ]);\n  const note    = buildNote({ message, city });\n\n  // UTM / yclid\n  const utm_source   = src.utm_source   || '';\n  const utm_medium   = src.utm_medium   || '';\n  const utm_campaign = src.utm_campaign || '';\n  const utm_content  = src.utm_content  || '';\n  const utm_term     = src.utm_term     || '';\n  const yclid        = src.yclid        || '';\n\n  const custom_value_json = JSON.stringify({\n    utm_source, utm_medium, utm_campaign, utm_content, utm_term, yclid,\n  });\n\n  const payload = {\n    name: childName,\n    ...(notEmpty(parentName) ? { legal_name: parentName } : {}),\n    ...(dob_raw_value !== undefined && dob_raw_value !== null ? { dob } : {}), // вообще без изменений\n    branch_ids: [1],\n    legal_type: 1,\n    is_study: 0,\n    lead_source_id,\n\n    ...(notEmpty(phone) ? { phone: [phone] } : {}),\n    ...(contact_contacts.length ? { contact_contacts } : {}),\n    ...(emailArr.length ? { email: emailArr } : {}),\n\n    ...(notEmpty(note) ? { note } : {}),\n\n    ...(notEmpty(utm_source)   ? { custom_utm_source: utm_source } : {}),\n    ...(notEmpty(utm_medium)   ? { custom_utm_medium: utm_medium } : {}),\n    ...(notEmpty(utm_campaign) ? { custom_utm_campaign: utm_campaign } : {}),\n    ...(notEmpty(utm_content)  ? { custom_utm_content: utm_content } : {}),\n    ...(notEmpty(utm_term)     ? { custom_utm_term: utm_term } : {}),\n    ...(notEmpty(yclid)        ? { custom_yclid: yclid } : {}),\n    custom_value_json,\n  };\n\n  const res = await createCustomer(this, { host, token, payload });\n\n  out.push({\n    json: {\n      success: res.success,\n      response: res.response,\n      sent: payload,\n      },\n    }\n  });\n}\n\nreturn out;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        560,
        0
      ],
      "id": "3c64d274-b17a-4fab-8cbe-edfc72e08a16",
      "name": "Send Lead data to CRM"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://kiberonesaratov.s20.online/v2api/1/lesson/index",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-ALFACRM-TOKEN",
              "value": "={{ $json.token }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "id",
              "value": "={{ $('Webhook').item.json.body.selected_lesson_id }}"
            },
            {
              "name": "status",
              "value": "1"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        960,
        0
      ],
      "id": "6489580f-2f2d-4c52-bda3-32190f00d54e",
      "name": "Get Lesson by ID"
    },
    {
      "parameters": {
        "jsCode": "// Loop over input items and add a new field called 'myNewField' to the JSON of each one\n$input.first().json.items[0].customer_ids.push($('Send Lead data to CRM').first().json.response.model.id);\n\n\nreturn $input.all();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1152,
        0
      ],
      "id": "ad50f613-7889-4355-aee8-71887ad29db4",
      "name": "Append students to the list"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://kiberonesaratov.s20.online/v2api/1/lesson/update?id={{ $json.items[0].id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-ALFACRM-TOKEN",
              "value": "={{ $('Get X-ALFACRM-TOKEN').item.json.token }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "customer_ids",
              "value": "={{$input.first().json.items[0].customer_ids}}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1360,
        0
      ],
      "id": "ae6e46d2-40ea-4fc1-99a8-93a471fd0909",
      "name": "Push updated students list"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://kiberonesaratov.s20.online/v2api/auth/login",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "email",
              "value": "={{ $('Set CRM data').item.json.alfacrm.email }}"
            },
            {
              "name": "api_key",
              "value": "={{ $('Set CRM data').item.json.alfacrm.api_key }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        768,
        0
      ],
      "id": "84324a82-fd46-4178-bab3-c1c89262b33b",
      "name": "Get X-ALFACRM-TOKEN"
    },
    {
      "parameters": {
        "jsCode": "// n8n Code (JavaScript) — Run Once for All Items\nconst items = await $input.all();\n\n// --- helpers ---\nconst notEmpty = v => v !== undefined && v !== null && String(v).trim() !== '';\n\nfunction tryParseJSON(s) {\n  if (typeof s !== 'string') return s;\n  try { return JSON.parse(s); } catch { return s; }\n}\n\nfunction getQueryParam(url, name) {\n  try { return new URL(String(url)).searchParams.get(name); } catch { return null; }\n}\n\n/**\n * Рекурсивно находит ВСЕ ключи \"lead_source_id\" и подменяет значение.\n * Сохраняет тип: если раньше было \"40\" (string), запишет \"8\"/\"3\" как строку.\n * Возвращает количество замен.\n */\nfunction replaceLeadSourceId(obj, newValNumber) {\n  let count = 0;\n  const stack = [obj];\n  const seen = new Set();\n\n  while (stack.length) {\n    const cur = stack.pop();\n    if (!cur || typeof cur !== 'object') continue;\n    if (seen.has(cur)) continue;\n    seen.add(cur);\n\n    if (Array.isArray(cur)) {\n      for (const v of cur) if (v && typeof v === 'object') stack.push(v);\n      continue;\n    }\n\n    for (const [k, v] of Object.entries(cur)) {\n      if (k === 'lead_source_id') {\n        const keepString = typeof v === 'string';\n        cur[k] = keepString ? String(newValNumber) : newValNumber;\n        count++;\n      }\n      if (v && typeof v === 'object') stack.push(v);\n    }\n  }\n  return count;\n}\n\nfor (const item of items) {\n  const src = item.json ?? item;\n\n  // --- где взять yclid ---\n  let yclid = src.yclid ?? src.yclidid ?? null;\n\n  // из page_url (?yclid=...)\n  if (!notEmpty(yclid) && src.page_url) {\n    const q = getQueryParam(src.page_url, 'yclid');\n    if (notEmpty(q)) yclid = q;\n  }\n\n  // из custom_value_json (если там хранится)\n  if (!notEmpty(yclid) && src.custom_value_json) {\n    const cv = tryParseJSON(src.custom_value_json);\n    if (cv && typeof cv === 'object' && 'yclid' in cv && notEmpty(cv.yclid)) {\n      yclid = cv.yclid;\n    }\n  }\n\n  const newVal = notEmpty(yclid) ? 8 : 3;\n\n  // подменяем ВЕЗДЕ, где уже есть lead_source_id\n  const replaced = replaceLeadSourceId(src, newVal);\n\n  // лог для проверки\n  console.log({ resolved_yclid: yclid ?? null, new_lead_source_id: newVal, replaced_keys: replaced });\n\n  // если нужно также гарантированно обновить верхнеуровневое значение (которое ты показал в примере),\n  // и оно есть в корне — продублируем:\n  if ('lead_source_id' in src) {\n    src.lead_source_id = typeof src.lead_source_id === 'string' ? String(newVal) : newVal;\n  }\n\n  // записываем обратно в item\n  if (item.json) item.json = src; else Object.assign(item, src);\n}\n\nreturn items;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        352,
        0
      ],
      "id": "79f5740d-dbe2-4a03-96c8-06d23385ae67",
      "name": "update lead_source_id"
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Respond to Webhook1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set CRM data": {
      "main": [
        [
          {
            "node": "update lead_source_id",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respond to Webhook1": {
      "main": [
        [
          {
            "node": "Set CRM data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Lead data to CRM": {
      "main": [
        [
          {
            "node": "Get X-ALFACRM-TOKEN",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Lesson by ID": {
      "main": [
        [
          {
            "node": "Append students to the list",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Append students to the list": {
      "main": [
        [
          {
            "node": "Push updated students list",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get X-ALFACRM-TOKEN": {
      "main": [
        [
          {
            "node": "Get Lesson by ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "update lead_source_id": {
      "main": [
        [
          {
            "node": "Send Lead data to CRM",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": null,
  "pinData": {},
  "versionId": "a969c789-c3c2-43d7-b438-11c33e4fa68b",
  "triggerCount": 1,
  "shared": [
    {
      "updatedAt": "2025-11-10T10:12:13.473Z",
      "createdAt": "2025-11-10T10:12:13.473Z",
      "role": "workflow:owner",
      "workflowId": "fsy7TJJRLJ5nc0Fc",
      "projectId": "spKmbJLU4mvACXIB"
    }
  ],
  "tags": []
}