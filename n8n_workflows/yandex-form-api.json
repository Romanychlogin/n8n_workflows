{
  "updatedAt": "2025-11-10T11:32:52.805Z",
  "createdAt": "2025-11-10T10:12:13.473Z",
  "id": "fsy7TJJRLJ5nc0Fc",
  "name": "yandex form API",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "7761af7e-68c6-4e99-ab82-e3acfdc463bc",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        0,
        0
      ],
      "id": "d3beae44-1400-44d8-8010-8ecbae0b2f2c",
      "name": "Webhook",
      "webhookId": "d0b73f09-ea23-4cd3-a92c-db7497c60763"
    },
    {
      "parameters": {
        "options": {
          "responseCode": 200,
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "https://trylesson.storage.yandexcloud.net"
              },
              {
                "name": "Vary",
                "value": "Origin"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        272,
        0
      ],
      "id": "a2712e29-ad95-4946-ae6c-bc49b0a3914e",
      "name": "Respond to Webhook1"
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "{\n  \"alfacrm\": {\n    \"host\": \"kiberonesaratov.s20.online\",\n    \"email\": \"kiberone.saratov@gmail.com\",\n    \"api_key\": \"0bc94111-6567-11f0-b9b8-3cecefbdd1ae\",\n  }\n}",
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        512,
        0
      ],
      "id": "42a54067-a57c-4667-ad1c-e7cc9d4c9851",
      "name": "Set CRM data"
    },
    {
      "parameters": {
        "jsCode": "/**\n * AlfaCRM update by entity_id (n8n \"Code (JavaScript)\" node)\n * — логин → (опционально) чтение клиента → апдейт клиента\n */\n\n// ---------- helpers ----------\nconst toNum = (v) => {\n  if (v === undefined || v === null) return undefined;\n  const n = Number(String(v).trim());\n  return Number.isFinite(n) ? n : undefined;\n};\nfunction first(...vals) {\n  for (const v of vals) {\n    if (v !== undefined && v !== null && String(v).trim() !== '') return String(v).trim();\n  }\n  return undefined;\n}\nfunction asObj(maybe) {\n  if (!maybe) return {};\n  if (typeof maybe === 'object') return maybe;\n  if (typeof maybe === 'string') {\n    try { return JSON.parse(maybe); } catch { return {}; }\n  }\n  return {};\n}\n// Достаём JSON из другого узла (работает в режиме \"Run Once For All Items\")\nfunction fromNode(nodeName) {\n  try { return $items(nodeName, 0, 0)?.json ?? {}; } catch { return {}; }\n}\n\n// Глубокий поиск по ключу\nfunction findKeyDeep(obj, keyMatcher) {\n  const seen = new Set();\n  const stack = [obj];\n  while (stack.length) {\n    const cur = stack.pop();\n    if (!cur || typeof cur !== 'object') continue;\n    if (seen.has(cur)) continue;\n    seen.add(cur);\n    if (Array.isArray(cur)) {\n      for (const v of cur) if (v && typeof v === 'object') stack.push(v);\n      continue;\n    }\n    for (const [k, v] of Object.entries(cur)) {\n      if (keyMatcher(k)) return v;\n      if (v && typeof v === 'object') stack.push(v);\n    }\n  }\n  return undefined;\n}\n\nasync function http(req) { return await this.helpers.httpRequest(req); }\n\nasync function login(self, { host, email, api_key, x_app_key }) {\n  const headers = { 'Accept': 'application/json', 'Content-Type': 'application/json' };\n  if (x_app_key) headers['X-APP-KEY'] = x_app_key;\n  const res = await http.call(self, {\n    method: 'POST',\n    url: `https://${host}/v2api/auth/login`,\n    headers,\n    body: { email, api_key },\n    json: true, gzip: true, timeout: 15000,\n  });\n  if (!res?.token) throw new Error('AlfaCRM: no token in auth response');\n  return res.token;\n}\n\nasync function getCustomer(self, { host, token, branchId, entity_id, x_app_key }) {\n  const headers = {\n    'Accept': 'application/json',\n    'Content-Type': 'application/json',\n    'X-ALFACRM-TOKEN': token,\n  };\n  if (x_app_key) headers['X-APP-KEY'] = x_app_key;\n  const res = await http.call(self, {\n    method: 'POST',\n    url: `https://${host}/v2api/${branchId}/customer/index`,\n    headers,\n    body: { id: entity_id, page: 0 },\n    json: true, gzip: true, timeout: 15000,\n  });\n  return Array.isArray(res?.items) ? res.items.find(i => Number(i.id) === Number(entity_id)) : null;\n}\n\nasync function updateCustomer(self, { host, token, branchId, entity_id, payload, x_app_key }) {\n  const headers = {\n    'Accept': 'application/json',\n    'Content-Type': 'application/json',\n    'X-ALFACRM-TOKEN': token,\n  };\n  if (x_app_key) headers['X-APP-KEY'] = x_app_key;\n  return await http.call(self, {\n    method: 'POST',\n    url: `https://${host}/v2api/${branchId}/customer/update`,\n    qs: { id: entity_id },\n    headers,\n    body: payload,\n    json: true, gzip: true, timeout: 20000,\n  });\n}\n\nfunction buildPayload(update, currentNote) {\n  const payload = {};\n\n  // lead_status_ids как было\n  if (Array.isArray(update.lead_status_ids)) payload.lead_status_ids = update.lead_status_ids;\n\n  // lead_source_id: принимаем и числа, и числовые строки\n  if (update.lead_source_id !== undefined && update.lead_source_id !== null && String(update.lead_source_id).trim() !== '') {\n    const n = Number(String(update.lead_source_id).trim());\n    if (Number.isFinite(n)) payload.lead_source_id = n;\n  }\n\n  // custom_value_json — всегда строкой\n  if (update.custom_value_json && typeof update.custom_value_json === 'object') {\n    payload.custom_value_json = JSON.stringify(update.custom_value_json);\n  } else if (typeof update.custom_value_json === 'string') {\n    payload.custom_value_json = update.custom_value_json;\n  }\n\n  // только custom_* и как строки\n  if (update.custom_plain && typeof update.custom_plain === 'object') {\n    for (const [k, v] of Object.entries(update.custom_plain)) {\n      if (v === undefined || v === null) continue;\n      if (!k.startsWith('custom_')) continue;\n      if (payload[k] === undefined) payload[k] = String(v);\n    }\n  }\n\n  if (update.note_append) {\n    payload.note = (currentNote || '') + (currentNote ? '\\n' : '') + String(update.note_append);\n  }\n  return payload;\n}\n\n// ---------- input normalization ----------\nconst input = $json;\nif (!input?.alfacrm?.host || !input?.alfacrm?.email || !input?.alfacrm?.api_key) {\n  throw new Error('Provide alfacrm.host, alfacrm.email, alfacrm.api_key');\n}\n\n// распарсим возможные строки\nconst bodyObj   = asObj(input.body);\nconst paramsObj = asObj(input.params);\nconst queryObj  = asObj(input.query);\n\n// плюс попробуем достать из других нод\nconst jWebhook      = fromNode('Webhook');\nconst jVisitors     = fromNode('Get visitors');\nconst jLastVisitor  = fromNode('Get the last visitor');\nconst jUpdateRows   = fromNode('Update row(s)');\nconst jCredentials  = fromNode('Set credentials');\n\n// branchId: из текущего item, либо из webhook/body\nconst branchId =\n  toNum(input.alfacrm.branchId) ??\n  toNum(input.branch_id) ??\n  toNum(bodyObj.branch_id) ??\n  toNum(asObj(jWebhook.body).branch_id);\n\nif (!branchId) throw new Error('Provide alfacrm.branchId or body.branch_id');\n\n// entity_id: из текущего item + из других нод\nconst entity_id = \n  toNum(input.entity_id) ??\n  toNum(input.customerId) ??\n  toNum(bodyObj.entity_id) ??\n  toNum(paramsObj.entity_id) ??\n  toNum(queryObj.entity_id) ??\n  // из Webhook (часто здесь)\n  toNum(asObj(jWebhook.body).entity_id) ??\n  toNum(jWebhook.entity_id) ??\n  // вдруг где-то лежит просто id\n  toNum(bodyObj.id) ?? toNum(paramsObj.id) ?? toNum(queryObj.id) ??\n  toNum(jUpdateRows.entity_id) ??\n  toNum(jLastVisitor.entity_id) ??\n  toNum(jVisitors.entity_id) ??\n  toNum(jCredentials.entity_id);\n\nif (!entity_id) {\n  console.log('ENTITY_ID CANDIDATES:', {\n    'input.entity_id': input.entity_id,\n    'input.customerId': input.customerId,\n    'body.entity_id': bodyObj.entity_id,\n    'params.entity_id': paramsObj.entity_id,\n    'query.entity_id': queryObj.entity_id,\n    'webhook.body.entity_id': asObj(jWebhook.body).entity_id,\n    'webhook.entity_id': jWebhook.entity_id,\n    'updateRows.entity_id': jUpdateRows.entity_id,\n    'lastVisitor.entity_id': jLastVisitor.entity_id,\n    'visitors.entity_id': jVisitors.entity_id,\n    'credentials.entity_id': jCredentials.entity_id,\n  });\n  throw new Error('Provide numeric entity_id');\n}\n\nconst { host, email, api_key, x_app_key } = input.alfacrm;\nconst update = input.update || {};\n\n// ---------- ВАЖНО: берём уже посчитанный lead_source_id из входящего item ----------\nconst leadFromStreamRaw = findKeyDeep(input, k => k === 'lead_source_id'); // ищем где угодно\nconst leadFromStream = toNum(leadFromStreamRaw);\nif (leadFromStream !== undefined) {\n  update.lead_source_id = leadFromStream; // используем значение из предыдущей ноды\n}\n\n// ---------- inferred yclid/etext (не влияет на lead_source_id, можно оставить) ----------\nconst inferred_yclid = first(\n  update?.custom_plain?.custom_yclid,\n  input.custom_yclid, input.yclid,\n  bodyObj.custom_yclid, bodyObj.yclid,\n  asObj(jWebhook.body).custom_yclid, asObj(jWebhook.body).yclid\n);\nconst inferred_etext = first(\n  update?.custom_plain?.custom_etext,\n  input.custom_etext, input.etext,\n  bodyObj.custom_etext, bodyObj.etext,\n  asObj(jWebhook.body).custom_etext, asObj(jWebhook.body).etext\n);\nupdate.custom_plain = Object.assign({}, update.custom_plain);\nif (inferred_yclid && !update.custom_plain.custom_yclid) update.custom_plain.custom_yclid = inferred_yclid;\nif (inferred_etext && !update.custom_plain.custom_etext) update.custom_plain.custom_etext = inferred_etext;\n\n// ---------- flow ----------\nlet token = await login(this, { host, email, api_key, x_app_key });\n\nlet existing = null;\ntry { existing = await getCustomer(this, { host, token, branchId, entity_id, x_app_key }); } catch {}\n\nconst payload = buildPayload(update, existing?.note);\n\ntry {\n  const res = await updateCustomer(this, { host, token, branchId, entity_id, payload, x_app_key });\n  return [{ json: { success: true, response: res, sent: payload, entity_id, branchId } }];\n} catch (err) {\n  const status = err?.statusCode || err?.response?.statusCode;\n  if (status === 401) {\n    token = await login(this, { host, email, api_key, x_app_key });\n    const res2 = await updateCustomer(this, { host, token, branchId, entity_id, payload, x_app_key });\n    return [{ json: { success: true, response: res2, sent: payload, entity_id, branchId, retried: true } }];\n  }\n  throw new Error(`AlfaCRM update failed: ${JSON.stringify(err?.response?.body || err)}`);\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        928,
        0
      ],
      "id": "11ba8144-0d34-43e8-ba2f-f8b53d2123bc",
      "name": "Send Lead data to CRM"
    },
    {
      "parameters": {
        "jsCode": "// n8n Code (JavaScript) — Run Once for All Items\nconst items = await $input.all();\n\n// --- helpers ---\nconst notEmpty = v => v !== undefined && v !== null && String(v).trim() !== '';\n\nfunction tryParseJSON(s) {\n  if (typeof s !== 'string') return s;\n  try { return JSON.parse(s); } catch { return s; }\n}\n\nfunction getQueryParam(url, name) {\n  try { return new URL(String(url)).searchParams.get(name); } catch { return null; }\n}\n\n/**\n * Рекурсивно находит ВСЕ ключи \"lead_source_id\" и подменяет значение.\n * Сохраняет тип: если раньше было \"40\" (string), запишет \"8\"/\"3\" как строку.\n * Возвращает количество замен.\n */\nfunction replaceLeadSourceId(obj, newValNumber) {\n  let count = 0;\n  const stack = [obj];\n  const seen = new Set();\n\n  while (stack.length) {\n    const cur = stack.pop();\n    if (!cur || typeof cur !== 'object') continue;\n    if (seen.has(cur)) continue;\n    seen.add(cur);\n\n    if (Array.isArray(cur)) {\n      for (const v of cur) if (v && typeof v === 'object') stack.push(v);\n      continue;\n    }\n\n    for (const [k, v] of Object.entries(cur)) {\n      if (k === 'lead_source_id') {\n        const keepString = typeof v === 'string';\n        cur[k] = keepString ? String(newValNumber) : newValNumber;\n        count++;\n      }\n      if (v && typeof v === 'object') stack.push(v);\n    }\n  }\n  return count;\n}\n\nfor (const item of items) {\n  const src = item.json ?? item;\n\n  // --- где взять yclid ---\n  let yclid = src.yclid ?? src.yclidid ?? null;\n\n  // из page_url (?yclid=...)\n  if (!notEmpty(yclid) && src.page_url) {\n    const q = getQueryParam(src.page_url, 'yclid');\n    if (notEmpty(q)) yclid = q;\n  }\n\n  // из custom_value_json (если там хранится)\n  if (!notEmpty(yclid) && src.custom_value_json) {\n    const cv = tryParseJSON(src.custom_value_json);\n    if (cv && typeof cv === 'object' && 'yclid' in cv && notEmpty(cv.yclid)) {\n      yclid = cv.yclid;\n    }\n  }\n\n  const newVal = notEmpty(yclid) ? 8 : 3;\n\n  // подменяем ВЕЗДЕ, где уже есть lead_source_id\n  const replaced = replaceLeadSourceId(src, newVal);\n\n  // лог для проверки\n  console.log({ resolved_yclid: yclid ?? null, new_lead_source_id: newVal, replaced_keys: replaced });\n\n  // если нужно также гарантированно обновить верхнеуровневое значение (которое ты показал в примере),\n  // и оно есть в корне — продублируем:\n  if ('lead_source_id' in src) {\n    src.lead_source_id = typeof src.lead_source_id === 'string' ? String(newVal) : newVal;\n  }\n\n  // записываем обратно в item\n  if (item.json) item.json = src; else Object.assign(item, src);\n}\n\nreturn items;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        720,
        0
      ],
      "id": "59885bdb-f042-4dbb-9cab-829a137b1626",
      "name": "update lead_source_id",
      "disabled": true
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Respond to Webhook1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set CRM data": {
      "main": [
        [
          {
            "node": "update lead_source_id",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "update lead_source_id": {
      "main": [
        [
          {
            "node": "Send Lead data to CRM",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respond to Webhook1": {
      "main": [
        [
          {
            "node": "Set CRM data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": null,
  "pinData": {
    "Webhook": [
      {
        "json": {
          "headers": {
            "host": "n8n-main-production-4310.up.railway.app",
            "user-agent": "axios/1.13.2",
            "content-length": "567",
            "accept": "application/json, text/plain, */*",
            "accept-encoding": "gzip, compress, deflate, br",
            "content-type": "application/json",
            "x-forwarded-for": "185.206.167.180",
            "x-forwarded-host": "n8n-main-production-4310.up.railway.app",
            "x-forwarded-proto": "https",
            "x-railway-edge": "railway/europe-west4-drams3a",
            "x-railway-request-id": "pbfgkjlcThKNKXX55nX1uw",
            "x-real-ip": "185.206.167.180",
            "x-request-start": "1762771684760"
          },
          "params": {},
          "query": {},
          "body": {
            "form": "trial_lesson",
            "location": "ул. Т. Г. Шевченко, 8",
            "subject": "Пробное занятие — 1 час",
            "selected_date": "2025-11-13",
            "selected_time_from": "19:00",
            "selected_time_to": "20:00",
            "parent_name": "Anton test",
            "phone": "+79117932216",
            "email": "anton@test.ru",
            "child_name": "Артем",
            "child_birthdate": "2009-10-31",
            "meta": {
              "page_url": "https://trylesson.storage.yandexcloud.net/index.html",
              "user_agent": "Mozilla/5.0 (iPhone; CPU iPhone OS 18_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Mobile/15E148 Safari/604.1"
            }
          },
          "webhookUrl": "https://n8n-main-production-4310.up.railway.app/webhook/7761af7e-68c6-4e99-ab82-e3acfdc463bc",
          "executionMode": "production"
        }
      }
    ]
  },
  "versionId": "ef7b4f7c-a396-476d-91d1-12d2a906de90",
  "triggerCount": 1,
  "shared": [
    {
      "updatedAt": "2025-11-10T10:12:13.473Z",
      "createdAt": "2025-11-10T10:12:13.473Z",
      "role": "workflow:owner",
      "workflowId": "fsy7TJJRLJ5nc0Fc",
      "projectId": "spKmbJLU4mvACXIB"
    }
  ],
  "tags": []
}