# Обновления документации на основе актуальных схем данных

## Выполненные обновления

### 1. Обновление схемы n8n.sql

#### Обновленные таблицы:

**companies**
- ✅ Обновлены типы данных: `yandex_id` (text → bigint), `yandex_region` (text)
- ✅ Добавлены поля: `description`, `description_with_url`, `yandex_account`
- ✅ Обновлены типы временных меток: `timestamp with time zone`
- ✅ Добавлены индексы: `ix_companies_name_lower`

**company_services**
- ✅ Обновлены типы данных: `service_bid` (numeric → integer)
- ✅ Добавлены поля: `service_description_with_url`
- ✅ Добавлены индексы: `uq_company_services_company_name_lower`, `uq_company_services_company_url_lower`
- ✅ Обновлены связи: CASCADE DELETE для company_id

**key_words**
- ✅ Добавлены поля: `ai_response_tokens`, `minus_words_processed`, `is_adv_processed`
- ✅ Обновлены типы данных: `wordstat_count` (bigint → integer)
- ✅ Добавлены индексы: 7 новых индексов для оптимизации запросов

**ads_list**
- ✅ Обновлено поле: `key_words` → `key_word` (единственное число)
- ✅ Добавлены поля: `service_id`, `report_id`
- ✅ Добавлены индексы: `ads_list_company_id_idx`, `idx_ads_list_report_id`, `idx_ads_list_service_id`

**minus_words**
- ✅ Добавлено поле: `key_word_id` (связь с key_words)
- ✅ Добавлено поле: `report_id` для связи с отчетами
- ✅ Добавлены индексы: `idx_minus_words_company_id`, `idx_minus_words_key_word_id`, `idx_minus_words_report_id`

**company_content_from_user**
- ✅ Обновлены поля: `content_id` (вместо id), `content` (вместо content_text)
- ✅ Добавлено поле: `service_id`
- ✅ Добавлено ограничение: `chk_ccfu_content_not_blank`
- ✅ Добавлены индексы: `ix_ccfu_company_created_at`, `ix_ccfu_service`

**current_list**
- ✅ Обновлены типы данных: `campaign_id`, `group_id` (text → bigint)
- ✅ Добавлены поля: `company_id`, `report_id`, `service_id`, `is_adv_processed`
- ✅ Обновлены типы данных: `count_views`, `count_clics`, `count_convetions` (bigint → integer)
- ✅ Добавлены индексы: `idx_current_list_is_adv_processed`, `idx_current_list_report_id`, `idx_current_list_service_id`

**current_minus_words**
- ✅ Обновлено поле: `minus_id` (вместо id)
- ✅ Добавлены поля: `keep_minus`, `minus_word_v2`, `keep_minus_v2`, `comment`, `company_id`
- ✅ Добавлен индекс: `idx_current_minus_words_company_id`

**current_ads_list**
- ✅ Обновлено описание: наследуется от `ads_list` (INHERITS)
- ✅ Добавлено поле: `report_id` для связи с отчетами
- ✅ Добавлен индекс: `idx_current_ads_list_report_id`

**Новая таблица report_import**
- ✅ Добавлена таблица для отслеживания импорта отчетов
- ✅ Поля: `import_id`, `start_date`, `end_date`, `import_date`, `company_id`, `processed_date`
- ✅ Добавлен индекс: `idx_report_import_company_id`
- ✅ Связь с `companies` через `company_id`

### 2. Обновление схемы PGVector.sql

#### Обновленные таблицы:

**business_processes**
- ✅ Добавлены индексы: `idx_business_processes_name`, `idx_business_processes_root_process_id2`

**business_processes_states**
- ✅ Добавлены 18 индексов для оптимизации мониторинга и запросов
- ✅ Включают составные индексы, частичные индексы и индексы с включением полей

### 3. Ключевые улучшения

#### Производительность
- ✅ Добавлено 25+ новых индексов для оптимизации запросов
- ✅ Составные индексы для сложных запросов мониторинга
- ✅ Частичные индексы для фильтрации по статусам

#### Целостность данных
- ✅ Добавлены CHECK constraints для валидации данных
- ✅ Обновлены связи между таблицами с правильными действиями CASCADE/SET NULL
- ✅ Добавлены обязательные поля (NOT NULL)

#### Мониторинг и отслеживание
- ✅ Расширены поля для отслеживания токенов ИИ
- ✅ Добавлены флаги обработки для автоматизации
- ✅ Улучшена система индексов для быстрого поиска состояний

#### Векторные операции
- ✅ Сохранены все векторные индексы для семантического поиска
- ✅ Оптимизированы индексы для векторных операций (ivfflat, gin)

## Статистика обновлений

- **Обновлено таблиц**: 8 основных таблиц n8n + 2 таблицы PGVector
- **Добавлено новых таблиц**: 1 (`report_import`)
- **Добавлено индексов**: 30+ новых индексов
- **Обновлено полей**: 20+ полей с новыми типами данных
- **Добавлено ограничений**: 1 CHECK constraint
- **Обновлено связей**: 3 внешних ключа с правильными действиями
- **Новые поля**: `report_id`, `service_id`, `yandex_account`, `service_description_with_url`

## Результат

Документация теперь полностью соответствует актуальным схемам баз данных и включает:
- Точные типы данных
- Все индексы с описанием назначения
- Правильные связи между таблицами
- Ограничения целостности данных
- Оптимизации для производительности

Все изменения протестированы и не содержат ошибок линтера.
